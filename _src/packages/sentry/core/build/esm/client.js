import{getEnvelopeEndpointWithUrlEncodedAuth as F}from"./api.js";import{DEFAULT_ENVIRONMENT as L}from"./constants.js";import{getTraceContextFromScope as j,getCurrentScope as U,getIsolationScope as W}from"./currentScopes.js";import{DEBUG_BUILD as l}from"./debug-build.js";import{createEventEnvelope as J,createSessionEnvelope as V}from"./envelope.js";import{setupIntegration as Y,afterSetupIntegrations as D,setupIntegrations as G}from"./integration.js";import{updateSession as O}from"./session.js";import{getDynamicSamplingContextFromScope as z}from"./tracing/dynamicSamplingContext.js";import{getPossibleEventMessages as q}from"./utils/eventUtils.js";import{merge as H}from"./utils/merge.js";import{parseSampleRate as K}from"./utils/parseSampleRate.js";import{prepareEvent as Q}from"./utils/prepareEvent.js";import{showSpanDropWarning as k}from"./utils/spanUtils.js";import{convertTransactionEventToSpanJson as X,convertSpanJsonToTransactionEvent as Z}from"./utils/transactionEvent.js";import{createClientReportEnvelope as tt}from"./utils-hoist/clientreport.js";import{makeDsn as et,dsnToString as nt}from"./utils-hoist/dsn.js";import{addItemToEnvelope as st,createAttachmentEnvelopeItem as rt}from"./utils-hoist/envelope.js";import{isPrimitive as ot,isParameterizedString as it,isThenable as at,isPlainObject as w}from"./utils-hoist/is.js";import{logger as p}from"./utils-hoist/logger.js";import{uuid4 as S,checkOrSetAlreadyCaught as N}from"./utils-hoist/misc.js";import{resolvedSyncPromise as x,SyncPromise as ct,rejectedSyncPromise as pt}from"./utils-hoist/syncpromise.js";const R="Not capturing exception because it's already been captured.",T="Discarded session because of missing or non-string release",A=Symbol.for("SentryInternalError"),$=Symbol.for("SentryDoNotSendEventError");function g(i){return{message:i,[A]:!0}}function I(i){return{message:i,[$]:!0}}function C(i){return!!i&&typeof i=="object"&&A in i}function M(i){return!!i&&typeof i=="object"&&$ in i}class Ct{constructor(t){if(this._options=t,this._integrations={},this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],t.dsn?this._dsn=et(t.dsn):l&&p.warn("No DSN provided, client will not send events."),this._dsn){const e=F(this._dsn,t.tunnel,t._metadata?t._metadata.sdk:void 0);this._transport=t.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...t.transportOptions,url:e})}}captureException(t,e,n){const r=S();if(N(t))return l&&p.log(R),r;const s={event_id:r,...e};return this._process(this.eventFromException(t,s).then(c=>this._captureEvent(c,s,n))),s.event_id}captureMessage(t,e,n,r){const s={event_id:S(),...n},c=it(t)?t:String(t),o=ot(t)?this.eventFromMessage(c,e,s):this.eventFromException(t,s);return this._process(o.then(d=>this._captureEvent(d,s,r))),s.event_id}captureEvent(t,e,n){const r=S();if(e?.originalException&&N(e.originalException))return l&&p.log(R),r;const s={event_id:r,...e},c=t.sdkProcessingMetadata||{},o=c.capturedSpanScope,d=c.capturedSpanIsolationScope;return this._process(this._captureEvent(t,s,o||n,d)),s.event_id}captureSession(t){this.sendSession(t),O(t,{init:!1})}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(t){const e=this._transport;return e?(this.emit("flush"),this._isClientDoneProcessing(t).then(n=>e.flush(t).then(r=>n&&r))):x(!0)}close(t){return this.flush(t).then(e=>(this.getOptions().enabled=!1,this.emit("close"),e))}getEventProcessors(){return this._eventProcessors}addEventProcessor(t){this._eventProcessors.push(t)}init(){(this._isEnabled()||this._options.integrations.some(({name:t})=>t.startsWith("Spotlight")))&&this._setupIntegrations()}getIntegrationByName(t){return this._integrations[t]}addIntegration(t){const e=this._integrations[t.name];Y(this,t,this._integrations),e||D(this,[t])}sendEvent(t,e={}){this.emit("beforeSendEvent",t,e);let n=J(t,this._dsn,this._options._metadata,this._options.tunnel);for(const s of e.attachments||[])n=st(n,rt(s));const r=this.sendEnvelope(n);r&&r.then(s=>this.emit("afterSendEvent",t,s),null)}sendSession(t){const{release:e,environment:n=L}=this._options;if("aggregates"in t){const s=t.attrs||{};if(!s.release&&!e){l&&p.warn(T);return}s.release=s.release||e,s.environment=s.environment||n,t.attrs=s}else{if(!t.release&&!e){l&&p.warn(T);return}t.release=t.release||e,t.environment=t.environment||n}this.emit("beforeSendSession",t);const r=V(t,this._dsn,this._options._metadata,this._options.tunnel);this.sendEnvelope(r)}recordDroppedEvent(t,e,n=1){if(this._options.sendClientReports){const r=`${t}:${e}`;l&&p.log(`Recording outcome: "${r}"${n>1?` (${n} times)`:""}`),this._outcomes[r]=(this._outcomes[r]||0)+n}}on(t,e){const n=this._hooks[t]=this._hooks[t]||[];return n.push(e),()=>{const r=n.indexOf(e);r>-1&&n.splice(r,1)}}emit(t,...e){const n=this._hooks[t];n&&n.forEach(r=>r(...e))}sendEnvelope(t){return this.emit("beforeEnvelope",t),this._isEnabled()&&this._transport?this._transport.send(t).then(null,e=>(l&&p.error("Error while sending envelope:",e),e)):(l&&p.error("Transport disabled"),x({}))}_setupIntegrations(){const{integrations:t}=this._options;this._integrations=G(this,t),D(this,t)}_updateSessionFromEvent(t,e){let n=e.level==="fatal",r=!1;const s=e.exception?.values;if(s){r=!0;for(const d of s)if(d.mechanism?.handled===!1){n=!0;break}}const c=t.status==="ok";(c&&t.errors===0||c&&n)&&(O(t,{...n&&{status:"crashed"},errors:t.errors||Number(r||n)}),this.captureSession(t))}_isClientDoneProcessing(t){return new ct(e=>{let n=0;const r=1,s=setInterval(()=>{this._numProcessing==0?(clearInterval(s),e(!0)):(n+=r,t&&n>=t&&(clearInterval(s),e(!1)))},r)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._transport!==void 0}_prepareEvent(t,e,n,r){const s=this.getOptions(),c=Object.keys(this._integrations);return!e.integrations&&c?.length&&(e.integrations=c),this.emit("preprocessEvent",t,e),t.type||r.setLastEventId(t.event_id||e.event_id),Q(s,t,e,n,this,r).then(o=>{if(o===null)return o;this.emit("postprocessEvent",o,e),o.contexts={trace:j(n),...o.contexts};const d=z(this,n);return o.sdkProcessingMetadata={dynamicSamplingContext:d,...o.sdkProcessingMetadata},o})}_captureEvent(t,e={},n=U(),r=W()){return l&&b(t)&&p.log(`Captured error event \`${q(t)[0]||"<unknown>"}\``),this._processEvent(t,e,n,r).then(s=>s.event_id,s=>{l&&(M(s)?p.log(s.message):C(s)?p.warn(s.message):p.warn(s))})}_processEvent(t,e,n,r){const s=this.getOptions(),{sampleRate:c}=s,o=B(t),d=b(t),u=t.type||"error",h=`before send for type \`${u}\``,m=typeof c>"u"?void 0:K(c);if(d&&typeof m=="number"&&Math.random()>m)return this.recordDroppedEvent("sample_rate","error"),pt(I(`Discarding event because it's not included in the random sample (sampling rate = ${c})`));const y=u==="replay_event"?"replay":u;return this._prepareEvent(t,e,n,r).then(a=>{if(a===null)throw this.recordDroppedEvent("event_processor",y),I("An event processor returned `null`, will not send event.");if(e.data&&e.data.__sentry__===!0)return a;const f=lt(this,s,a,e);return dt(f,h)}).then(a=>{if(a===null){if(this.recordDroppedEvent("before_send",y),o){const v=1+(t.spans||[]).length;this.recordDroppedEvent("before_send","span",v)}throw I(`${h} returned \`null\`, will not send event.`)}const E=n.getSession()||r.getSession();if(d&&E&&this._updateSessionFromEvent(E,a),o){const _=a.sdkProcessingMetadata?.spanCountBeforeProcessing||0,v=a.spans?a.spans.length:0,P=_-v;P>0&&this.recordDroppedEvent("before_send","span",P)}const f=a.transaction_info;if(o&&f&&a.transaction!==t.transaction){const _="custom";a.transaction_info={...f,source:_}}return this.sendEvent(a,e),a}).then(null,a=>{throw M(a)||C(a)?a:(this.captureException(a,{data:{__sentry__:!0},originalException:a}),g(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${a}`))})}_process(t){this._numProcessing++,t.then(e=>(this._numProcessing--,e),e=>(this._numProcessing--,e))}_clearOutcomes(){const t=this._outcomes;return this._outcomes={},Object.entries(t).map(([e,n])=>{const[r,s]=e.split(":");return{reason:r,category:s,quantity:n}})}_flushOutcomes(){l&&p.log("Flushing outcomes...");const t=this._clearOutcomes();if(t.length===0){l&&p.log("No outcomes to send");return}if(!this._dsn){l&&p.log("No dsn provided, will not send outcomes");return}l&&p.log("Sending outcomes:",t);const e=tt(t,this._options.tunnel&&nt(this._dsn));this.sendEnvelope(e)}}function dt(i,t){const e=`${t} must return \`null\` or a valid event.`;if(at(i))return i.then(n=>{if(!w(n)&&n!==null)throw g(e);return n},n=>{throw g(`${t} rejected with ${n}`)});if(!w(i)&&i!==null)throw g(e);return i}function lt(i,t,e,n){const{beforeSend:r,beforeSendTransaction:s,beforeSendSpan:c}=t;let o=e;if(b(o)&&r)return r(o,n);if(B(o)){if(c){const d=c(X(o));if(d?o=H(e,Z(d)):k(),o.spans){const u=[];for(const h of o.spans){const m=c(h);m?u.push(m):(k(),u.push(h))}o.spans=u}}if(s){if(o.spans){const d=o.spans.length;o.sdkProcessingMetadata={...e.sdkProcessingMetadata,spanCountBeforeProcessing:d}}return s(o,n)}}return o}function b(i){return i.type===void 0}function B(i){return i.type==="transaction"}export{Ct as Client};
//# sourceMappingURL=client.js.map
