import{WINDOW as h}from"../types.js";import{trackClsAsStandaloneSpan as R}from"./cls.js";import{addPerformanceInstrumentationHandler as P,addFidInstrumentationHandler as $,addLcpInstrumentationHandler as B,addTtfbInstrumentationHandler as H,addClsInstrumentationHandler as O}from"./instrument.js";import{getBrowserPerformanceAPI as q,msToSec as u,startAndEndSpan as b,extractNetworkProtocol as x,isMeasurementValue as w}from"./utils.js";import{getActivationStart as z}from"./web-vitals/lib/getActivationStart.js";import{getNavigationEntry as L}from"./web-vitals/lib/getNavigationEntry.js";import{getVisibilityWatcher as F}from"./web-vitals/lib/getVisibilityWatcher.js";import{browserPerformanceTimeOrigin as g}from"../../../../../sentry/core/build/esm/utils-hoist/time.js";import{getActiveSpan as A,spanToJSON as y}from"../../../../../sentry/core/build/esm/utils/spanUtils.js";import{SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN as T}from"../../../../../sentry/core/build/esm/semanticAttributes.js";import{setMeasurement as V}from"../../../../../sentry/core/build/esm/tracing/measurement.js";import{parseUrl as W}from"../../../../../sentry/core/build/esm/utils-hoist/url.js";import{isPrimitive as I}from"../../../../../sentry/core/build/esm/utils-hoist/is.js";import{htmlTreeAsString as C,getComponentName as D}from"../../../../../sentry/core/build/esm/utils-hoist/browser.js";const U=2147483647;let M=0,f={},l,k;function gt({recordClsStandaloneSpans:e}){const t=q();if(t&&g()){t.mark&&h.performance.mark("sentry-tracing-init");const r=G(),n=J(),i=Y(),s=e?R():j();return()=>{r(),n(),i(),s?.()}}return()=>{}}function _t(){P("longtask",({entries:e})=>{const t=A();if(!t)return;const{op:r,start_timestamp:n}=y(t);for(const i of e){const s=u(g()+i.startTime),c=u(i.duration);r==="navigation"&&n&&s<n||b(t,s,s+c,{name:"Main UI thread blocked",op:"ui.long-task",attributes:{[T]:"auto.ui.browser.metrics"}})}})}function St(){new PerformanceObserver(t=>{const r=A();if(r)for(const n of t.getEntries()){if(!n.scripts[0])continue;const i=u(g()+n.startTime),{start_timestamp:s,op:c}=y(r);if(c==="navigation"&&s&&i<s)continue;const a=u(n.duration),o={[T]:"auto.ui.browser.metrics"},d=n.scripts[0],{invoker:m,invokerType:v,sourceURL:p,sourceFunctionName:_,sourceCharPosition:N}=d;o["browser.script.invoker"]=m,o["browser.script.invoker_type"]=v,p&&(o["code.filepath"]=p),_&&(o["code.function"]=_),N!==-1&&(o["browser.script.source_char_position"]=N),b(r,i,i+a,{name:"Main UI thread blocked",op:"ui.long-animation-frame",attributes:o})}}).observe({type:"long-animation-frame",buffered:!0})}function ht(){P("event",({entries:e})=>{const t=A();if(t){for(const r of e)if(r.name==="click"){const n=u(g()+r.startTime),i=u(r.duration),s={name:C(r.target),op:`ui.interaction.${r.name}`,startTime:n,attributes:{[T]:"auto.ui.browser.metrics"}},c=D(r.target);c&&(s.attributes["ui.component_name"]=c),b(t,n,n+i,s)}}})}function j(){return O(({metric:e})=>{const t=e.entries[e.entries.length-1];t&&(f.cls={value:e.value,unit:""},k=t)},!0)}function J(){return B(({metric:e})=>{const t=e.entries[e.entries.length-1];t&&(f.lcp={value:e.value,unit:"millisecond"},l=t)},!0)}function G(){return $(({metric:e})=>{const t=e.entries[e.entries.length-1];if(!t)return;const r=u(g()),n=u(t.startTime);f.fid={value:e.value,unit:"millisecond"},f["mark.fid"]={value:r+n,unit:"second"}})}function Y(){return H(({metric:e})=>{e.entries[e.entries.length-1]&&(f.ttfb={value:e.value,unit:"millisecond"})})}function kt(e,t){const r=q(),n=g();if(!r?.getEntries||!n)return;const i=u(n),s=r.getEntries(),{op:c,start_timestamp:a}=y(e);if(s.slice(M).forEach(o=>{const d=u(o.startTime),m=u(Math.max(0,o.duration));if(!(c==="navigation"&&a&&i+d<a))switch(o.entryType){case"navigation":{K(e,o,i);break}case"mark":case"paint":case"measure":{X(e,o,d,m,i);const v=F(),p=o.startTime<v.firstHiddenTime;o.name==="first-paint"&&p&&(f.fp={value:o.startTime,unit:"millisecond"}),o.name==="first-contentful-paint"&&p&&(f.fcp={value:o.startTime,unit:"millisecond"});break}case"resource":{tt(e,o,o.name,d,m,i);break}}}),M=Math.max(s.length-1,0),et(e),c==="pageload"){nt(f);const o=f["mark.fid"];o&&f.fid&&(b(e,o.value,o.value+u(f.fid.value),{name:"first input delay",op:"ui.action",attributes:{[T]:"auto.ui.browser.metrics"}}),delete f["mark.fid"]),(!("fcp"in f)||!t.recordClsOnPageloadSpan)&&delete f.cls,Object.entries(f).forEach(([d,m])=>{V(d,m.value,m.unit)}),e.setAttribute("performance.timeOrigin",i),e.setAttribute("performance.activationStart",z()),rt(e)}l=void 0,k=void 0,f={}}function X(e,t,r,n,i){const s=L(!1),c=u(s?s.requestStart:0),a=i+Math.max(r,c),o=i+r,d=o+n,m={[T]:"auto.resource.browser.metrics"};if(a!==o&&(m["sentry.browser.measure_happened_before_request"]=!0,m["sentry.browser.measure_start_time"]=a),t.detail)if(typeof t.detail=="object")for(const[v,p]of Object.entries(t.detail))if(p&&I(p))m[`sentry.browser.measure.detail.${v}`]=p;else try{m[`sentry.browser.measure.detail.${v}`]=JSON.stringify(p)}catch{}else if(I(t.detail))m["sentry.browser.measure.detail"]=t.detail;else try{m["sentry.browser.measure.detail"]=JSON.stringify(t.detail)}catch{}a<=d&&b(e,a,d,{name:t.name,op:t.entryType,attributes:m})}function K(e,t,r){["unloadEvent","redirect","domContentLoadedEvent","loadEvent","connect"].forEach(n=>{S(e,t,n,r)}),S(e,t,"secureConnection",r,"TLS/SSL"),S(e,t,"fetch",r,"cache"),S(e,t,"domainLookup",r,"DNS"),Z(e,t,r)}function S(e,t,r,n,i=r){const s=Q(r),c=t[s],a=t[`${r}Start`];!a||!c||b(e,n+u(a),n+u(c),{op:`browser.${i}`,name:t.name,attributes:{[T]:"auto.ui.browser.metrics",...r==="redirect"&&t.redirectCount!=null?{"http.redirect_count":t.redirectCount}:{}}})}function Q(e){return e==="secureConnection"?"connectEnd":e==="fetch"?"domainLookupStart":`${e}End`}function Z(e,t,r){const n=r+u(t.requestStart),i=r+u(t.responseEnd),s=r+u(t.responseStart);t.responseEnd&&(b(e,n,i,{op:"browser.request",name:t.name,attributes:{[T]:"auto.ui.browser.metrics"}}),b(e,s,i,{op:"browser.response",name:t.name,attributes:{[T]:"auto.ui.browser.metrics"}}))}function tt(e,t,r,n,i,s){if(t.initiatorType==="xmlhttprequest"||t.initiatorType==="fetch")return;const c=W(r),a={[T]:"auto.resource.browser.metrics"};E(a,t,"transferSize","http.response_transfer_size"),E(a,t,"encodedBodySize","http.response_content_length"),E(a,t,"decodedBodySize","http.decoded_response_content_length");const o=t.deliveryType;o!=null&&(a["http.response_delivery_type"]=o);const d=t.renderBlockingStatus;d&&(a["resource.render_blocking_status"]=d),c.protocol&&(a["url.scheme"]=c.protocol.split(":").pop()),c.host&&(a["server.address"]=c.host),a["url.same_origin"]=r.includes(h.location.origin);const{name:m,version:v}=x(t.nextHopProtocol);a["network.protocol.name"]=m,a["network.protocol.version"]=v;const p=s+n,_=p+i;b(e,p,_,{name:r.replace(h.location.origin,""),op:t.initiatorType?`resource.${t.initiatorType}`:"resource.other",attributes:a})}function et(e){const t=h.navigator;if(!t)return;const r=t.connection;r&&(r.effectiveType&&e.setAttribute("effectiveConnectionType",r.effectiveType),r.type&&e.setAttribute("connectionType",r.type),w(r.rtt)&&(f["connection.rtt"]={value:r.rtt,unit:"millisecond"})),w(t.deviceMemory)&&e.setAttribute("deviceMemory",`${t.deviceMemory} GB`),w(t.hardwareConcurrency)&&e.setAttribute("hardwareConcurrency",String(t.hardwareConcurrency))}function rt(e){l&&(l.element&&e.setAttribute("lcp.element",C(l.element)),l.id&&e.setAttribute("lcp.id",l.id),l.url&&e.setAttribute("lcp.url",l.url.trim().slice(0,200)),l.loadTime!=null&&e.setAttribute("lcp.loadTime",l.loadTime),l.renderTime!=null&&e.setAttribute("lcp.renderTime",l.renderTime),e.setAttribute("lcp.size",l.size)),k?.sources&&k.sources.forEach((t,r)=>e.setAttribute(`cls.source.${r+1}`,C(t.node)))}function E(e,t,r,n){const i=t[r];i!=null&&i<U&&(e[n]=i)}function nt(e){const t=L(!1);if(!t)return;const{responseStart:r,requestStart:n}=t;n<=r&&(e["ttfb.requestTime"]={value:r-n,unit:"millisecond"})}export{X as _addMeasureSpans,K as _addNavigationSpans,tt as _addResourceSpans,kt as addPerformanceEntries,ht as startTrackingInteractions,St as startTrackingLongAnimationFrames,_t as startTrackingLongTasks,gt as startTrackingWebVitals};
//# sourceMappingURL=browserMetrics.js.map
