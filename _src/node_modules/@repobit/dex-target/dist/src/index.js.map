{"version":3,"file":"index.js","sources":["../../../../../../node_modules/@repobit/dex-target/dist/src/index.js"],"sourcesContent":["import { Constants } from '@repobit/dex-constants';\nimport { AdobeDataLayerService, CdpEvent } from \"@repobit/dex-data-layer\";\nexport default class Target {\n    urlParameters;\n    profileUrlParameters;\n    cachedMboxes;\n    _configMbox;\n    controller = new AbortController();\n    _visitorInfo;\n    cdpData;\n    constructor(config) {\n        this.urlParameters = this.getUrlParameters();\n        this.profileUrlParameters = this.transfromIntoProfileParameters(this.urlParameters);\n        this.cachedMboxes = new Map();\n        if (!window.alloyProxy) {\n            function __alloy(...args) {\n                return new Promise((resolve, reject) => {\n                    window.alloyProxy.q.push([resolve, reject, args]);\n                });\n            }\n            window.alloyProxy = __alloy;\n            window.alloyProxy.q = [];\n        }\n        // check for dotest=1 in URL. If it exists abort all target calls\n        const urlParams = new URLSearchParams(window.location.search);\n        if (urlParams.get('dotest') === '1') {\n            this.abort();\n        }\n        this._visitorInfo = new Promise((resolve) => {\n            if (this.controller.signal?.aborted) {\n                resolve({});\n            }\n            window.alloyProxy(\"getIdentity\").then(result => resolve(result))\n                .catch(() => resolve({}));\n            this.controller.signal?.addEventListener(\"abort\", () => resolve({}));\n        });\n        this.cdpData = config?.pageLoadStartedEvent ? this.sendCdpData(config?.pageLoadStartedEvent) : Promise.resolve({});\n        this._configMbox = this.getOffers({ mboxNames: 'config-mbox' });\n    }\n    /** get an object containing all the url query parameters */\n    getUrlParameters() {\n        const urlParams = new URLSearchParams(window.location.search);\n        const parameters = {};\n        urlParams.forEach((value, key) => {\n            parameters[key] = value;\n        });\n        return parameters;\n    }\n    get configMbox() {\n        return this._configMbox;\n    }\n    get visitorInfo() {\n        return this._visitorInfo;\n    }\n    /** add adobe_mc parameter at the end of the url */\n    appendVisitorIDsTo(url) {\n        if (this.controller.signal?.aborted || url.includes('adobe_mc')) {\n            return Promise.resolve(url);\n        }\n        return new Promise((resolve) => {\n            window.alloyProxy(\"appendIdentityToUrl\", { url }).then(result => resolve(result.url))\n                .catch(() => resolve(url));\n            this.controller.signal?.addEventListener(\"abort\", () => resolve(url));\n        });\n    }\n    /** abort all the Target calls for casese where Target does not load */\n    abort() {\n        this.controller.abort();\n    }\n    async sendCdpData(pageLoadStartedEvent) {\n        let cdpData = {};\n        try {\n            const cdpDataCall = await fetch(`${Constants.PUBLIC_URL_ORIGIN}/cdp/`, {\n                method: 'POST',\n                body: JSON.stringify({\n                    mcvisid: (await this.visitorInfo)?.identity?.ECID || '',\n                    ...pageLoadStartedEvent.page\n                })\n            });\n            /** @type {{auds: string[], mdl: {key: string, value: string}[], ub: any[] vid: string}} */\n            const receivedCdpData = await cdpDataCall.json();\n            cdpData = {\n                auds: receivedCdpData?.auds[0] || ''\n            };\n            if (receivedCdpData.mdl) {\n                cdpData = receivedCdpData?.mdl.reduce((acc, mdlValue) => {\n                    acc[mdlValue.key] = mdlValue.value;\n                    return acc;\n                }, cdpData);\n            }\n            AdobeDataLayerService.push(new CdpEvent(cdpData));\n        }\n        catch (e) {\n            console.warn(e);\n        }\n        return cdpData;\n    }\n    transfromIntoProfileParameters(object) {\n        const profileObject = Object.keys(object).reduce((acc, key) => {\n            acc[`profile.${key}`] = object[key];\n            return acc;\n        }, {});\n        return profileObject;\n    }\n    async getOffers(param) {\n        let { mboxNames } = param;\n        const isInitialyArray = Array.isArray(mboxNames);\n        const { parameters, profileParameters } = param;\n        if (!Array.isArray(mboxNames)) {\n            mboxNames = [mboxNames];\n        }\n        const cdpData = await this.cdpData;\n        if (this.controller.signal?.aborted) {\n            return mboxNames.length > 1 ? {} : undefined;\n        }\n        const notRequestedMboxes = mboxNames.filter(mbox => !this.cachedMboxes.has(`${mbox}_${JSON.stringify(parameters)}`));\n        if (notRequestedMboxes.length) {\n            const notRequestedOffersCall = window.alloyProxy('sendEvent', {\n                type: \"decisioning.propositionFetch\",\n                decisionScopes: notRequestedMboxes,\n                data: {\n                    \"__adobe\": {\n                        \"target\": Object.assign({}, this.urlParameters, this.profileUrlParameters, parameters ? parameters : {}, profileParameters ? profileParameters : {}, cdpData, this.transfromIntoProfileParameters(cdpData))\n                    }\n                },\n                renderDecisions: true\n            });\n            notRequestedOffersCall.then(result => {\n                window.alloyProxy('applyPropositions', {\n                    \"propositions\": result.propositions,\n                    \"viewName\": window.location.href\n                });\n            });\n            notRequestedMboxes.forEach(mbox => {\n                const receivedMboxOfferCall = new Promise((resolve, reject) => {\n                    notRequestedOffersCall.then(result => {\n                        const mboxResult = result.propositions.find((offer) => offer.scope === mbox)?.items[0].data?.content;\n                        resolve(mboxResult);\n                    }).catch(e => {\n                        reject(e);\n                    });\n                    this.controller.signal?.addEventListener(\"abort\", reject);\n                });\n                this.cachedMboxes.set(`${mbox}_${JSON.stringify(parameters)}_${JSON.stringify(profileParameters)}`, receivedMboxOfferCall);\n            });\n        }\n        const mboxesPromises = mboxNames.map(mboxName => this.cachedMboxes.get(`${mboxName}_${JSON.stringify(parameters)}_${JSON.stringify(profileParameters)}`));\n        const resolvedMboxes = await Promise.allSettled(mboxesPromises);\n        const offersResult = mboxNames.reduce((acc, mboxName, index) => {\n            acc[mboxName] = resolvedMboxes[index].status === 'fulfilled' ? resolvedMboxes[index].value : undefined;\n            return acc;\n        }, {});\n        return isInitialyArray ? offersResult : offersResult[mboxNames[0]];\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":[],"mappings":"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","x_google_ignoreList":[0]}