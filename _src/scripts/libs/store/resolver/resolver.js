import{AdobeDataLayerService as O}from"../../../../packages/repobit/dex-data-layer/dist/src/adobe-data-layer-service/index.js";import"../../../../packages/repobit/dex-utils/dist/src/index.js";import{ProductInfo as E,Store as B,ProductOption as M}from"../store.js";import{FranklinProductsLoadedEvent as C}from"../../data-layer.js";import{staticAttributes as R,staticAttributesResolvers as V}from"./staticAttributes/index.js";import{clickAttributes as Y,clickAttributeResolvers as j}from"./clickAttributes/index.js";import{staticGlobalAttributesResolvers as $}from"./staticGlobalAttributes/index.js";class w{static variations=[];static solveStaticAttributes(){D.resolveStaticGlobalAttributes(document.querySelector("main")||document.querySelector("body"))}}class q{constructor(t,s,r,o,d,n,f,m,A){this.products=m,this._product=t,this.staticAttributes=o,this.clickAttributes=d,this.contexts=n,this.contextProducts=f,this.bundle=null,this._devices=s,this._years=r,this._option=t.getOption(s,r),this.devicePropertiesMapping=Object.entries(A).reduce((g,[v,l])=>(g[v]=Object.entries(l).reduce((p,[k,e])=>(p[`CFV_${k.toUpperCase()}`]=e,p),{}),g),{}),this.devicePropertiesVariables=Object.keys(Object.values(this.devicePropertiesMapping)[0]||{}),this._option.deviceMapping=this.devicePropertiesMapping[this.devices]}get years(){return this._years}set years(t){const s=this.product.getOption(this._devices,Number(t))||this.product.getOption(this.product.getSubscriptions("years",Number(t))[0],Number(t));s&&(this._years=Number(t),this._option=s,this.solveStaticAttributes())}get devices(){return this._devices}set devices(t){const s=this.product.getOption(Number(t),this._years)||this.product.getOption(Number(t),this.product.getSubscriptions("years",Number(t))[0]);s&&(this._devices=Number(t),this._option=s,this._option.deviceMapping=this.devicePropertiesMapping[this.devices],this.solveStaticAttributes())}get option(){if(this.bundle){const t=this.product.getOption(this.devices,this.years,this.bundle);return t.deviceMapping=this.devicePropertiesMapping[this.devices],t}return this._option}set option(t){const[s,r]=b(t),o=this.product.getOption(s,r);o&&(this._devices=s,this._years=r,this._option=o,this._option.deviceMapping=this.devicePropertiesMapping[this.devices],this.solveStaticAttributes())}get product(){return this._product}set product(t){this.products[t]&&(this._product=this.products[t])}solveStaticAttributes(){this.staticAttributes.forEach(t=>D.resolveStaticAttributes(t,this))}setBundle(t,s){if(!t){this.bundle=null,this.solveStaticAttributes();return}const o=this.products[t]?.getOption(...b(s));o&&(this.bundle=o,this.solveStaticAttributes())}}const J=(h,t)=>{switch(h.nodeName){case"INPUT":h.value=t;break;default:h.innerHTML=t;break}},b=h=>{const t=h.split("-");if(t.length<2)return[1,1];let s=t.length>2?1:0;const r=t[s++].replace(/\D/g,""),[o]=t[s].split(/[ym]/);return[Number(r),Number(o)]};window.parseKey=b;class D{static contextAttributes={storeId:"[data-store-id]",storeDepartment:"[data-store-department]",storeOption:"[data-store-option]",storePromotion:"[data-store-promotion]",storeEvent:"[data-store-event]",storeKey:"[data-store-key]",storeContext:"[data-store-context]",storeDevicePropertiesMapping:"[data-store-device-properties-mapping]"};static staticAttributes=R;static clickAttributes=Y;static async resolve(t=document){await Promise.allSettled([this.#t(t),...[...t.querySelectorAll("[data-shadow-dom]")].map(s=>this.#t(s.shadowRoot))])}static async#t(t){const s=t.querySelectorAll(`${this.contextAttributes.storeId}${this.contextAttributes.storeDepartment}`);if(s.length===0)return;const r=[...s,...this.getAdditionalProducts(t)].map(n=>{try{return new E(n.dataset.storeId,n.dataset.storeDepartment,n.dataset.storePromotion)}catch(f){return console.error(f.message),null}}).filter(n=>!!n),o=await B.getProducts(r),d=t.querySelectorAll(`${this.contextAttributes.storeContext}`);for(const n of d){const f=this.getAllProducts(n),m=n.dataset.storeId?[]:this.getAllAttributes(n,this.staticAttributes),A=n.dataset.storeId?[]:this.getAllAttributes(n,this.clickAttributes),g=[],v=[...f,...this.getAdditionalProducts(n)].map(l=>o[l.dataset.storeId]);for(const l of f){const p=o[l.dataset.storeId],k=JSON.parse(l.dataset?.storeDevicePropertiesMapping||"{}");if(!p)continue;const e=this.getAllOptions(l),i=l.dataset.storeOption?[]:this.getAllAttributes(l,this.staticAttributes),c=l.dataset.storeOption?[]:this.getAllAttributes(l,this.clickAttributes);for(const a of e){const u=[...this.getAllAttributes(a,this.staticAttributes),...i,...m],I=[...this.getAllAttributes(a,this.clickAttributes),...c,...A],[N,_]=b(a.dataset.storeOption),S=p.getOption(N,_);if(!S)continue;const y=new q(p,N,_,u,I,g,v,o,k);switch(g.push(y),w.variations.push(...this.getAllVariationsFromContext(y)),u.forEach(P=>this.resolveStaticAttributes(P,y)),I.forEach(P=>this.resolveClickAttributes(P,y)),a.dataset.storeEvent){case"product-loaded":O.push(new C(S,"all"));break;case"main-product-loaded":O.push(new C(S,"info"));break;case"product-comparison":O.push(new C(S,"comparison"));break}}}}w.solveStaticAttributes()}static resolveStaticAttributes(t,s){V.forEach(r=>{try{r(t,s)}catch(o){console.error(o)}})}static resolveClickAttributes(t,s){j.forEach(r=>{try{r(t,s)}catch(o){console.log(o)}})}static resolveStaticGlobalAttributes(t){$.forEach(s=>{try{s(t)}catch(r){console.log(r)}})}static getAllVariationsFromContext(t){const s=e=>{const i=[];switch(e.nodeName){case"INPUT":if(e.dataset.storeClickSetDevices!==void 0){const[c,a]=t.product.getMinMaxDeviceNumbers();for(let u=c;u<=a;u++)i.push(t.product.getOption(u,t.years))}break;case"SELECT":e.dataset.storeClickSetDevices!==void 0&&[...e.options].forEach(c=>i.push(t.product.getOption(Number(c.value),t.years))),e.dataset.storeClickSetYears!==void 0&&[...e.options].forEach(c=>i.push(t.product.getOption(t.devices,Number(c.value)))),e.dataset.storeClickSetProduct!==void 0&&[...e.options].forEach(c=>{const[a,u]=b(c.dataset.storeProductOption||`${t.devices}-${t.years}`);i.push(t.products[c.dataset.storeProductId]?.getOption(a,u))});break;default:if(e.dataset.storeClickSetDevices!==void 0&&i.push(t.product.getOption(Number(e.dataset.storeClickSetDevices),t.years)),e.dataset.storeClickSetYears!==void 0&&i.push(t.product.getOption(t.devices,Number(e.dataset.storeClickSetYears))),e.dataset.storeClickSetOption){const[c,a]=b(e.dataset.storeClickSetOption);i.push(t.product.getOption(c,a))}if(e.dataset.storeClickSetProduct!==void 0){const[c,a]=b(e.dataset.storeProductOption||`${t.devices}-${t.years}`);i.push(t.products[e.dataset.storeProductId]?.getOption(c,a))}if(e.dataset.storeClickToggleBundle!==void 0){const[c,a]=b(e.dataset.storeBundleOption);i.push(t.products[e.dataset.storeBundleId]?.getOption(c,a))}break}return i.filter(c=>!!c)},r=(e,i,c)=>{let a,u;switch(c){case"devices":a=i.getDevices(),u=e.getSubscription("years");break;case"subscription":a=e.getDevices(),u=i.getSubscription("years");break;case"all":a=i.getDevices(),u=i.getSubscription("years");break;case"none":a=e.getDevices(),u=e.getSubscription("years");break;default:return null}return t.products[e.getId()].getOption(a,u,c==="bundle"?i:null)},o=t.clickAttributes.filter(e=>e.dataset.storeClickSetDevices!==void 0).reduce((e,i)=>e.concat(s(i)),[]),d=t.clickAttributes.filter(e=>e.dataset.storeClickSetYears!==void 0).reduce((e,i)=>e.concat(s(i)),[]),n=t.clickAttributes.filter(e=>e.dataset.storeClickSetOption).reduce((e,i)=>e.concat(s(i)),[]),f=t.clickAttributes.filter(e=>e.dataset.storeClickSetProduct!==void 0).reduce((e,i)=>e.concat(s(i)),[]),m=t.clickAttributes.filter(e=>e.dataset.storeClickToggleBundle!==void 0).reduce((e,i)=>e.concat(s(i)),[]),A=d.reduce((e,i)=>e.concat(o.map(c=>r(i,c,"devices"))),[]).concat(d.length===0?o:[],n,[t.option]).filter(e=>!!e),[g,v]=t.clickAttributes.filter(e=>e.nodeName==="SELECT"&&(e.dataset.storeClickSetYears!==void 0||e.dataset.storeClickSetDevices!==void 0)).sort(e=>e.dataset.storeClickSetDevices!==void 0?-1:1),l=e=>{const i=t.products[e.getId()];if(g&&v)return i.getAllOptions();if(g)return i.getSubscriptions("years",e.getDevices()).map(c=>i.getOption(e.getDevices(),c));if(v)return i.getDevices(e.getSubscription("years")).map(c=>i.getOption(c,e.getSubscription("years")))},p=f.filter(e=>e.getId()!==t.product.getId()).reduce((e,i)=>e.concat(A.map(c=>r(i,c,"all")),l(i)),[]).filter(e=>!!e),k=[...A,...p].reduce((e,i)=>e.concat(m.map(c=>r(i,c,"bundle"))),[]).filter(e=>!!e);return[...A,...p,...k].filter(e=>e instanceof M)}static getAllProducts(t){const s=[...t.children],r=[];for(const o of s)if(!o.dataset.storeContext){if(o.dataset.storeId&&o.dataset.storeDepartment){r.push(o);continue}s.push(...o.children)}return t.dataset.storeId&&t.dataset.storeDepartment&&r.push(t),r}static getAllOptions(t){const s=[...t.children],r=[];for(const o of s)if(!o.dataset.storeId){if(o.dataset.storeOption){r.push(o);continue}s.push(...o.children)}return t.dataset.storeOption&&r.push(t),r}static getAllAttributes(t,s){const r=[...t.children],o=[];for(const d of r)if(!(d.dataset.storeId||d.dataset.storeOption||d.dataset.storeContext)){for(const n of Object.keys(d.dataset))if(Object.keys(s).includes(n)){o.push(d);break}r.push(...d.children)}for(const d of Object.keys(t.dataset))if(Object.keys(s).includes(d)){o.push(t);break}return o}static getAdditionalProducts(t){return[...t.querySelectorAll("[data-store-product-id], [data-store-bundle-id]")].map(s=>{const r=document.createElement("div");return r.setAttribute("data-store-id",s.dataset.storeProductId||s.dataset.storeBundleId),r.setAttribute("data-store-option",s.dataset.storeProductOption||s.dataset.storeBundleOption||""),r.setAttribute("data-store-department",s.dataset.storeProductDepartment||s.dataset.storeBundleDepartment),r.setAttribute("data-store-promotion",s.dataset.storeProductPromotion||s.dataset.storeBundlePromotion||""),r.setAttribute("data-store-region",s.dataset.storeProductRegion||s.dataset.storeBundleRegion||0),r.setAttribute("data-store-platform",s.dataset.storeProductPlatform||s.dataset.storeBundlePlatform||0),r})}}window.StoreResolverWebsites=D;export{q as Context,w as GlobalContext,D as StoreResolver,b as parseKey,J as writeValue};
//# sourceMappingURL=resolver.js.map
