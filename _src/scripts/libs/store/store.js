import{target as m}from"../../target.js";import"../../../node_modules/@repobit/dex-utils/dist/src/index.js";import{Constants as a}from"../constants.js";import{getUrlPromotion as N,getMetadata as P,getCampaignBasedOnLocale as f,GLOBAL_V2_LOCALES as g,setUrlParams as _}from"../../utils/utils.js";import l from"../../page.js";import D from"../../../node_modules/@repobit/dex-utils/dist/src/user.js";class v{constructor(e,r,t=null,i=!1){this.id=e,this.department=r,this.promotion=t,this.forcePromotion=i}}class b{constructor(e){this.price=e.price,this.priceDiscounted=e.priceDiscounted,this.buyLink=e.buyLink,this.isDiscounted=e.isDiscounted,this.currency=e.currency,this.symbol=e.symbol,this.devices=e.devices,this.subscription=e.subscription,this.id=e.id,this.productId=e.productId,this.productAlias=e.productAlias,this.department=e.department,this.name=e.name,this.avangateId=e.avangateId}getId(){return this.id}getProductId(){return this.productId}getProductAlias(){return this.productAlias}getAvangateId(){return this.avangateId}getName(){return this.name}getCurrency(){return this.currency}getSymbol(){return this.symbol}getDepartment(){return this.department}getVariation(){return`${this.devices}u-${this.getSubscription()}y`}getPrice(e="valueWithCurrency"){switch(e){case"value":return this.price;case"valueWithCurrency":return u.placeSymbol(this.price,this.currency);case"monthly":return this.subscription===1?this.price:Number(Number(this.price/this.subscription).toFixed(2));case"monthlyWithCurrency":return this.subscription===1?u.placeSymbol(this.price,this.currency):u.placeSymbol(Number(Number(this.price/this.subscription).toFixed(2)),this.currency)}}getDiscountedPrice(e="valueWithCurrency"){switch(e){case"value":return this.priceDiscounted;case"valueWithCurrency":return u.placeSymbol(this.priceDiscounted,this.currency);case"monthly":return this.subscription===1?this.priceDiscounted:Number(Number(this.priceDiscounted/this.subscription).toFixed(2));case"monthlyWithCurrency":return this.subscription===1?u.placeSymbol(this.priceDiscounted,this.currency):u.placeSymbol(Number(Number(this.priceDiscounted/this.subscription).toFixed(2)),this.currency)}}getDiscount(e="value"){const r=Math.round((this.price-this.priceDiscounted+Number.EPSILON)*100)/100||0,t=Math.round((this.price-this.priceDiscounted)/this.price*100)||0;switch(e){case"value":return r;case"valueWithCurrency":return u.placeSymbol(r,this.currency);case"percentage":return t;case"percentageWithProcent":return`${t}%`;default:return""}}async getStoreUrl(e){return e?Array.isArray(e)?await m.appendVisitorIDsTo(_(this.buyLink,e)):(console.error(`params must be an Array but you provided an ${typeof e}`),this.buyLink):this.buyLink}getDevices(){return this.devices}getSubscription(e="years"){switch(e){case"years":return a.PRODUCT_ID_MAPPINGS[this.id].isMonthlyProduct?this.subscription:this.subscription/12;case"months":return this.subscription}}}class y{constructor(e){this.id=e.id,this.productId=e.product_id,this.productAlias=e.product_alias,this.name=e.product_name,this.options=e.variations,this.department=e.department,this.promotion=e.promotion||(g.find(t=>l.locale===t)?"global_v2":"");const r=Object.values(Object.values(e.variations)[0])[0];if(this.currency=r.currency_iso,this.avangateId=Object.values(Object.values(e.variations)[0])[0]?.platform_product_id,this.yearDevicesMapping=Object.entries(this.options).reduce((t,[i,o])=>(Object.keys(o).forEach(c=>{if(!t[c]){t[c]=[Number(i)];return}t[c].push(Number(i))}),t),{}),u.config.provider==="vlaicu"&&Object.keys(a.WRONG_DEVICES_PRODUCT_IDS).includes(e.product_alias)){const t=a.WRONG_DEVICES_PRODUCT_IDS[e.product_alias].contentDevices,i=a.WRONG_DEVICES_PRODUCT_IDS[e.product_alias].providerDevices;this.options[t]=this.options[i],this.yearDevicesMapping[t]?this.yearDevicesMapping[t].push(i):this.yearDevicesMapping[t]=[i]}}getId(){return this.id}getProductId(){return this.productId}getProductAlias(){return this.productAlias}getAvangateId(){return this.avangateId}getName(){return this.name}getCurrency(){return this.currency}getDepartment(){return this.department}hasSomePrice(){for(const e of Object.values(this.options))for(const r of Object.values(e))if(Number(r.price))return!0;return!1}hasSomeDiscountedPrice(){for(const e of Object.values(this.options))for(const r of Object.values(e))if(Number(r.discount?.discounted_price))return!0;return!1}getOption(e,r,t){const i=`${e}-${r}`,o=this.options[e],c=o&&o[r];if(!c)return null;const s=new b({price:Number(Number(c.price).toFixed(2)),priceDiscounted:Number(Number(c.discount?.discounted_price).toFixed(2)),isDiscounted:!!c.discount?.discounted_price,currency:this.currency,symbol:this.symbol,name:this.name,id:this.id,productId:this.productId,productAlias:this.productAlias,department:this.department,devices:e,subscription:a.PRODUCT_ID_MAPPINGS[this.id].isMonthlyProduct?1:r*12,avangateId:this.avangateId});t&&(s.priceDiscounted&&t.priceDiscounted&&(s.price=Number(Number(s.price+t.price).toFixed(2)),s.priceDiscounted=Number(Number(s.priceDiscounted+t.priceDiscounted).toFixed(2))),s.priceDiscounted&&!t.priceDiscounted&&(s.price=Number(Number(s.price+t.price).toFixed(2)),s.priceDiscounted=Number(Number(s.priceDiscounted+t.price).toFixed(2))),!s.priceDiscounted&&t.priceDiscounted&&(s.price=Number(Number(s.price+t.priceDiscounted).toFixed(2))),!s.priceDiscounted&&!t.priceDiscounted&&(s.price=Number(Number(s.price+t.price).toFixed(2))));let n=new URL(c.buyLink);n.searchParams.set("SHOPURL",`${window.location.origin}/${window.location.pathname.split("/")[1]}/`),n.searchParams.set("REF",this.promotion&&this.promotion!==u.NO_PROMOTION?`WEBSITES_${this.promotion}`:"N/A"),n.searchParams.set("SRC",`${window.location.origin}${window.location.pathname}`);const d=u.targetBuyLinkMappings?.[this.productAlias]?.[i];return d&&(n=new URL(d.buyLink),d?.extraParameters?.forEach(p=>{n.searchParams.set(p.key,p.value)})),window.UC_UI&&n.searchParams.set("ucControllerId",window.UC_UI.getControllerId()),s.buyLink=n.href,s}getAllOptions(){const e=[];return Object.entries(this.options).forEach(([r,t])=>{Object.keys(t).forEach(i=>{e.push(this.getOption(r,i))})}),e}getPrice(e,r="valueWithCurrency"){let t=e==="max"?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,i=1;for(const o of Object.values(this.options))for(const[c,s]of Object.entries(o)){const n=Number(Number(s.price).toFixed(2));(e==="min"&&n<t||e==="max"&&n>t)&&(t=n,i=a.PRODUCT_ID_MAPPINGS[this.id].isMonthlyProduct?1:Number(c)*12)}if(t===(e==="max"?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER))return NaN;switch(r){case"value":return t;case"valueWithCurrency":return u.placeSymbol(t,this.currency);case"monthly":return i===1?t:Number(Number(t/i).toFixed(2));case"monthlyWithCurrency":return i===1?u.placeSymbol(t,this.currency):u.placeSymbol(Number(Number(t/i).toFixed(2)),this.currency)}}getDiscountedPrice(e,r="valueWithCurrency"){let t=e==="max"?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,i=1;for(const o of Object.values(this.options))for(const[c,s]of Object.entries(o)){const n=Number(Number(s.discount?.discounted_price).toFixed(2));(e==="min"&&n<t||e==="max"&&n>t)&&(t=n,i=a.PRODUCT_ID_MAPPINGS[this.id].isMonthlyProduct?1:Number(c)*12)}if(t===(e==="max"?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER))return NaN;switch(r){case"value":return t;case"valueWithCurrency":return u.placeSymbol(t,this.currency);case"monthly":return i===1?t:Number(Number(t/i).toFixed(2));case"monthlyWithCurrency":return i===1?u.placeSymbol(t,this.currency):u.placeSymbol(Number(Number(t/i).toFixed(2)),this.currency)}}getDiscount(e,r="value"){let t=e==="max"?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,i=NaN;for(const o of Object.values(this.options))for(const c of Object.values(o)){const s=Number(Number(c.discount?.discounted_price).toFixed(2)),n=Number(Number(c.price).toFixed(2)),d=Math.round((n-s+Number.EPSILON)*100)/100||0,p=Math.round((n-s)/n*100)||0;(e==="min"&&d<t||e==="max"&&d>t)&&(t=d,i=p)}if(t===(e==="max"?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER))return NaN;switch(r){case"value":return t;case"valueWithCurrency":return u.placeSymbol(t,this.currency);case"percentage":return i;case"percentageWithProcent":return`${i}%`;default:return""}}getSmallestPrice(e="valueWithCurrency"){let r=Number.MAX_SAFE_INTEGER,t=1;for(const i of Object.values(this.options))for(const[o,c]of Object.entries(i)){const s=Number(Number(c.discount?.discounted_price||c.price).toFixed(2));s<r&&(r=s,t=a.PRODUCT_ID_MAPPINGS[this.id].isMonthlyProduct?1:Number(o)*12)}if(r===Number.MAX_SAFE_INTEGER)return NaN;switch(e){case"value":return r;case"valueWithCurrency":return u.placeSymbol(r,this.currency);case"monthly":return t===1?r:Number(Number(r/t).toFixed(2));case"monthlyWithCurrency":return t===1?u.placeSymbol(r,this.currency):u.placeSymbol(Number(Number(r/t).toFixed(2)),this.currency)}}getMinMaxDeviceNumbers(){let e=Number.MAX_SAFE_INTEGER,r=0;for(const t of Object.keys(this.options)){const i=Number(t);i<e&&(e=i),i>r&&(r=i)}return[e,r]}getMinMaxYearNumbers(){let e=Number.MAX_SAFE_INTEGER,r=0;const t=Object.values(this.options)[0];for(const i of Object.keys(t)){const o=Number(i);o<e&&(e=o),o>r&&(r=o)}return[e,r]}getDevices(e){return this.yearDevicesMapping[e]}getSubscriptions(e="years",r){const t=Object.keys(this.options[r]);switch(e){case"years":return t.map(i=>Number(i));case"months":return a.PRODUCT_ID_MAPPINGS[this.id].isMonthlyProduct?t.map(i=>Number(i)):t.map(i=>Number(i)*12)}}}class I{static defaultPromotionPath="/p-api/v1/products/{bundleId}/locale/{locale}";static promotionPath="/p-api/v1/products/{bundleId}/locale/{locale}/campaign/{campaignId}";static#e(e){return e==="com.bitdefender.dataprivacy"&&l.locale==="ro-ro"?"DIP-RO":e==="com.bitdefender.dataprivacy"&&l.locale!=="ro-ro"?"DIP-promo":""}static#t(e){return a.SOHO_CORNER_CASES_LOCALSE.includes(l.locale)&&e==="com.bitdefender.soho"?"SOHO_DE":""}static#r(e){const r=new URL(e);return r.searchParams.set("LANG",l.language),r.href}static async getProductVariations(e,r){let t=this.#t(e)?"en-mt":l.locale;(await m.configMbox)?.useGeoIpPricing&&(t=await D.locale);const o={"{locale}":t,"{bundleId}":e,"{campaignId}":this.#e(e)||this.#t(e)||r};let c=r!==a.NO_PROMOTION||this.#e(e)||this.#t(e)?this.promotionPath:this.defaultPromotionPath;const s=new RegExp(Object.keys(o).join("|"),"gi");c=c.replace(s,d=>o[d]);const n=new URL(c,u.config.vlaicuEndpoint);try{const d=await fetch(n.href,{method:"GET",headers:{"Content-Type":"application/json"}});return d.ok?await d.json():null}catch(d){return console.error(d),null}}static async getProductVariationsPrice(e,r){const t=await this.getProductVariations(a.PRODUCT_ID_MAPPINGS[e.trim()].bundleId,r),i=t?.product;if(!i)return null;const o=t.campaign&&t.campaignType&&t.campaignType==="def";let c=i?.options;return!c||!c.length||(window.StoreProducts.product[e]={product_alias:e,product_id:a.PRODUCT_ID_MAPPINGS[e].bundleId,product_name:i.productName,promotion:o?t.campaign:r,variations:{}},c.forEach(s=>{if(a.PRODUCT_ID_MAPPINGS[e].isMonthlyProduct&&s.months>=12||!a.PRODUCT_ID_MAPPINGS[e].isMonthlyProduct&&s.months<12)return;const n=Math.ceil(s.months/12),d=s.slots,p={currency_iso:s.currency,product_id:a.PRODUCT_ID_MAPPINGS[e].bundleId,platform_product_id:t.platformProductId||a.PRODUCT_ID_MAPPINGS[e].bundleId,promotion:o?t.campaign:r,price:s.price,buyLink:this.#t(a.PRODUCT_ID_MAPPINGS[e].bundleId)?this.#r(s.buyLink):s.buyLink,variation:{variation_name:`${d}u-${n}y`,years:n}};s.discountAmount>0&&(p.discount={discounted_price:s.discountedPrice,discount_value:s.discountAmount}),window.StoreProducts.product[e].variations[d]=window.StoreProducts.product[e].variations[d]?window.StoreProducts.product[e].variations[d]:{},window.StoreProducts.product[e].variations[d][n]=p}),!Object.keys(window.StoreProducts.product[e].variations).length)?null:window.StoreProducts.product[e]}static async loadProduct(e,r){return window.StoreProducts=window.StoreProducts||[],window.StoreProducts.product=window.StoreProducts.product||{},await this.getProductVariationsPrice(e,r)}}class S{constructor(){this.provider="vlaicu",this.vlaicuEndpoint=a.DEV_DOMAINS.some(e=>window.location.hostname.includes(e))?"https://www.bitdefender.com":window.location.origin,this.httpMethod="GET"}}class u{static countriesMapping={gb:"uk",ch:"de",at:"de",us:"us",mx:"en",nz:"au"};static consumer="consumer";static business="business";static products={};static country=l.country;static mappedCountry=this.getCountry();static baseUrl=a.DEV_BASE_URL;static config=new S;static targetBuyLinkMappings=null;static async getProducts(e){return!Array.isArray(e)||!a.PRODUCT_ID_MAPPINGS?null:(this.targetBuyLinkMappings||(this.targetBuyLinkMappings=(await m.configMbox)?.products),e=[...new Map(e.map(r=>[`${r.id}`,r])).values()],this.products=(await Promise.allSettled(e.map(async r=>(r.forcePromotion||(r.promotion=(await m.configMbox)?.promotion||N()||r.promotion||P("pid")||f()),await this.#e(r))))).filter(r=>r.status==="fulfilled"&&!!r.value).map(r=>new y(r.value)).reduce((r,t)=>(r[t.getId()]=t,r),{}),this.products)}static async#e(e){try{const r=await I.loadProduct(e.id,e.promotion);return r?{...e,...r}:null}catch{return null}}static getCountry(){return this.countriesMapping[l.country]||l.country}static placeSymbol(e,r){return e?new Intl.NumberFormat("en-US",{style:"currency",currency:r}).format(e):""}}window.Store=u;window.Product=y;window.ProductOption=b;window.ProductInfo=v;export{y as Product,v as ProductInfo,b as ProductOption,u as Store};
//# sourceMappingURL=store.js.map
