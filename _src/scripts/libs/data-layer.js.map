{"version":3,"file":"data-layer.js","sources":["../../../src/scripts/libs/data-layer.js"],"sourcesContent":["import { target } from \"../target.js\";\nimport { User } from \"@repobit/dex-utils\";\nimport page from \"../page.js\";\nimport { PageLoadStartedEvent, UserDetectedEvent, ButtonClickEvent, PageErrorEvent, AdobeDataLayerService, ProductLoadedEvent } from \"@repobit/dex-data-layer\";\nimport {\n  getExperimentDetails,\n  generatePageLoadStartedName,\n  getCampaignBasedOnLocale,\n  getUrlPromotion,\n  getProductFinding,\n  getMetadata,\n} from '../utils/utils.js';\nimport { getTargetExperimentDetails } from \"../target.js\";\n\nexport class FranklinProductsLoadedEvent extends ProductLoadedEvent{\n  getOptionInfo(option) {\n    return {\n      ID: option.getAvangateId(),\n      name: option.getName(),\n      devices: option.getId() === 'psm' ? 10 : option.getDevices(), //DEPRECATED content - please remove after Vlaicu implementation\n      subscription: option.getSubscription(\"months\"),\n      version: option.getSubscription(\"months\") === 1 ? \"monthly\" : \"yearly\",\n      basePrice: option.getPrice(\"value\"),\n      discountValue: option.getDiscount(\"value\"),\n      discountRate: option.getDiscount(\"percentage\"),\n      currency: option.getCurrency(),\n      priceWithTax: option.getDiscountedPrice(\"value\") || option.getPrice(\"value\"),\n    };\n  }\n};\n\n/**\n * Page Error Handling\n */\nconst pageErrorHandling = () => {\n  const isErrorPage = window.errorCode === '404';\n  if(isErrorPage) {\n    AdobeDataLayerService.push(new PageErrorEvent());\n  }\n}\n\n/**\n * Add click events to the data layer after page redirect\n */\nconst checkClickEventAfterRedirect = () => {\n  if(localStorage.getItem(\"clickEvent\") !== null) {\n    const clickEvent = JSON.parse(localStorage.getItem(\"clickEvent\"));\n\n    if(clickEvent?.clickEvent) {\n      AdobeDataLayerService.push(new ButtonClickEvent(clickEvent.clickEvent, clickEvent.productId));\n    }\n\n    localStorage.removeItem(\"clickEvent\");\n  }\n}\n\n/**\n * Add entry for free products\n */\nconst getFreeProductsEvents = () => {\n  const currentPage = page.name;\n  if (currentPage === 'free-antivirus') {\n    // on Free Antivirus page we should add Free Antivirus as the main product\n    AdobeDataLayerService.push(new FranklinProductsLoadedEvent({\n      ID: '8430',\n    }, 'info'));\n  }\n}\n\n/**\n * push the pageLoadStartedEvent\n * and send data to CDP\n */\nconst resolvePageLoadStartedEvent = async () => {\n  // push the pageLoadStartedEvent to the Adobe Data Layer\n  AdobeDataLayerService.push(new PageLoadStartedEvent(\n    page,\n    {\n      name: generatePageLoadStartedName(),\n      experimentDetails: (await getTargetExperimentDetails()) ?? getExperimentDetails(),\n      geoRegion: await User.country,\n      serverName: 'hlx.live', // indicator for AEM Success Edge\n    },\n    {\n      promotionID: (await target.configMbox)?.promotion\n        || getUrlPromotion()\n        || getMetadata('pid')\n        || getCampaignBasedOnLocale()\n        || '',\n      internalPromotionID: page.getParamValue('icid') || '',\n      trackingID: page.getParamValue('cid') || '',\n    },\n  ));\n};\n\n/**\n * push the userDetectedEvent to the Data Layer\n */\nconst resolveUserDetectedEvent = async () => {\n  AdobeDataLayerService.push(new UserDetectedEvent(\n    page,\n    {\n      ID: await User.fingerprint,\n      productFinding: getProductFinding()\n    }\n  ));\n};\n\n/**\n * Resolve the data layer\n */\nexport const resolveNonProductsDataLayer = async () => {\n  await resolvePageLoadStartedEvent();\n  pageErrorHandling();\n  await resolveUserDetectedEvent();\n  checkClickEventAfterRedirect();\n  getFreeProductsEvents();\n}"],"names":[],"mappings":"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"}