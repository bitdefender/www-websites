{"version":3,"file":"target.js","sources":["../../src/scripts/target.js"],"sourcesContent":["/* eslint-disable max-classes-per-file */\nimport Target from '@repobit/dex-target';\nimport { PageLoadStartedEvent } from '@repobit/dex-data-layer';\nimport { User } from '@repobit/dex-utils';\nimport { sampleRUM } from './lib-franklin.js';\nimport page from './page.js';\nimport {\n  getMetadata,\n  shouldABTestsBeDisabled,\n  generatePageLoadStartedName,\n  GLOBAL_EVENTS,\n} from './utils/utils.js';\n\nexport const target = new Target({\n  pageLoadStartedEvent: new PageLoadStartedEvent(\n    page,\n    {\n      name: generatePageLoadStartedName(),\n      geoRegion: await User.country,\n      serverName: 'hlx.live', // indicator for AEM Success Edge\n    },\n  ),\n});\n\n/**\n * Convert a URL to a relative URL.\n * @param url\n * @returns {*|string}\n */\nfunction getPlainPageUrl(url) {\n  const { pathname, search, hash } = new URL(url, window.location.href);\n  const plainPagePathname = pathname.endsWith('/') ? `${pathname}index.plain.html` : `${pathname}.plain.html`;\n  return `${plainPagePathname}${search}${hash}`;\n}\n\n/**\n * Replace the current page with the challenger page.\n * @param url The challenger page url.\n * @returns {Promise<boolean>}\n */\nasync function navigateToChallengerPage(url) {\n  const plainPath = getPlainPageUrl(url);\n\n  const resp = await fetch(plainPath);\n  if (!resp.ok) {\n    throw new Error(`Failed to fetch challenger page: ${resp.status}`);\n  }\n\n  const mainElement = document.querySelector('main');\n  if (!mainElement) {\n    throw new Error('Main element not found');\n  }\n\n  mainElement.innerHTML = await resp.text();\n}\n\n/**\n* @param {string} experimentUrl\n* @param {string} experimentId\n* @return {Promise<{\n*  experimentId: string;\n*  experimentVariant: string;\n* }|null>}\n*/\n// eslint-disable-next-line import/prefer-default-export\nexport async function runTargetExperiment(experimentUrl, experimentId) {\n  if (!experimentUrl) {\n    return null;\n  }\n\n  try {\n    await navigateToChallengerPage(experimentUrl);\n\n    sampleRUM('target-experiment', {\n      source: `target:${experimentId}`,\n      target: experimentUrl,\n    });\n\n    return {\n      experimentId,\n      experimentVariant: experimentUrl,\n    };\n  } catch (e) {\n    return null;\n  }\n}\n\nexport function appendAdobeMcLinks(selector) {\n  try {\n    const wrapperSelector = typeof selector === 'string' ? document.querySelector(selector) : selector;\n\n    const hrefSelector = '[href*=\".bitdefender.\"]';\n    wrapperSelector.querySelectorAll(hrefSelector).forEach(async (link) => {\n      const destinationURLWithVisitorIDs = await target.appendVisitorIDsTo(link.href);\n      link.href = destinationURLWithVisitorIDs.replace(/MCAID%3D.*%7CMCORGID/, 'MCAID%3D%7CMCORGID');\n    });\n  } catch (e) {\n    // eslint-disable-next-line no-console\n    console.error(e);\n  }\n}\n\n/**\n* get experiment details from Target\n* @returns {Promise<{\n*  experimentId: string;\n*  experimentVariant: string;\n* } | null>}\n  */\nexport const getTargetExperimentDetails = async () => {\n  /**\n   * @type {{\n   *  experimentId: string;\n   *  experimentVariant: string;\n   * }|null}\n   */\n  let targetExperimentDetails = null;\n\n  async function loadCSS(href) {\n    return new Promise((resolve, reject) => {\n      if (!document.querySelector(`head > link[href=\"${href}\"]`)) {\n        const link = document.createElement('link');\n        link.rel = 'stylesheet';\n        link.href = href;\n        link.onload = resolve;\n        link.onerror = reject;\n        document.head.append(link);\n      } else {\n        resolve();\n      }\n    });\n  }\n\n  const targetExperimentLocation = getMetadata('target-experiment-location');\n  const targetExperimentId = getMetadata('target-experiment');\n  if (targetExperimentLocation && targetExperimentId && !shouldABTestsBeDisabled()) {\n    const offer = await target.getOffers({ mboxNames: targetExperimentLocation });\n    const { url, template } = offer || {};\n    if (template) {\n      loadCSS(`${window.hlx.codeBasePath}/scripts/template-factories/${template}.css`);\n      document.body.classList.add(template);\n    }\n    targetExperimentDetails = await runTargetExperiment(url, targetExperimentId);\n  }\n\n  return targetExperimentDetails;\n};\n\nexport function adobeMcAppendVisitorId(selector) {\n  // https://experienceleague.adobe.com/docs/id-service/using/id-service-api/methods/appendvisitorid.html?lang=en\n\n  if (window.ADOBE_MC_EVENT_LOADED) {\n    appendAdobeMcLinks(selector);\n  } else {\n    document.addEventListener(GLOBAL_EVENTS.ADOBE_MC_LOADED, () => {\n      appendAdobeMcLinks(selector);\n    });\n  }\n}\n"],"names":[],"mappings":"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"}