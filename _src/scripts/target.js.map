{"version":3,"file":"target.js","sources":["../../src/scripts/target.js"],"sourcesContent":["/* eslint-disable max-classes-per-file */\nimport Target from '@repobit/dex-target';\nimport { PageLoadStartedEvent } from '@repobit/dex-data-layer';\nimport { User } from '@repobit/dex-utils';\nimport { sampleRUM } from './lib-franklin.js';\nimport page from './page.js';\nimport {\n  getMetadata,\n  shouldABTestsBeDisabled,\n  generatePageLoadStartedName,\n  GLOBAL_EVENTS,\n} from './utils/utils.js';\n\nexport const target = new Target({\n  pageLoadStartedEvent: new PageLoadStartedEvent(\n    page,\n    {\n      name: generatePageLoadStartedName(),\n      geoRegion: await User.country,\n      serverName: 'hlx.live', // indicator for AEM Success Edge\n    },\n  ),\n});\n\n/**\n * Convert a URL to a relative URL.\n * @param url\n * @returns {*|string}\n */\nfunction getPlainPageUrl(url) {\n  const { pathname, search, hash } = new URL(url, window.location.href);\n  const plainPagePathname = pathname.endsWith('/') ? `${pathname}index.plain.html` : `${pathname}.plain.html`;\n  return `${plainPagePathname}${search}${hash}`;\n}\n\n/**\n * Replace the current page with the challenger page.\n * @param url The challenger page url.\n * @returns {Promise<boolean>}\n */\nasync function navigateToChallengerPage(url) {\n  const plainPath = getPlainPageUrl(url);\n\n  const resp = await fetch(plainPath);\n  if (!resp.ok) {\n    throw new Error(`Failed to fetch challenger page: ${resp.status}`);\n  }\n\n  const mainElement = document.querySelector('main');\n  if (!mainElement) {\n    throw new Error('Main element not found');\n  }\n\n  mainElement.innerHTML = await resp.text();\n}\n\n/**\n* @param {string} experimentUrl\n* @param {string} experimentId\n* @return {Promise<{\n*  experimentId: string;\n*  experimentVariant: string;\n* }|null>}\n*/\n// eslint-disable-next-line import/prefer-default-export\nexport async function runTargetExperiment(experimentUrl, experimentId) {\n  if (!experimentUrl) {\n    return null;\n  }\n\n  try {\n    await navigateToChallengerPage(experimentUrl);\n\n    sampleRUM('target-experiment', {\n      source: `target:${experimentId}`,\n      target: experimentUrl,\n    });\n\n    return {\n      experimentId,\n      experimentVariant: experimentUrl,\n    };\n  } catch (e) {\n    return null;\n  }\n}\n\nexport function appendAdobeMcLinks(selector) {\n  try {\n    const wrapperSelector = typeof selector === 'string' ? document.querySelector(selector) : selector;\n\n    const hrefSelector = '[href*=\".bitdefender.\"]';\n    wrapperSelector.querySelectorAll(hrefSelector).forEach(async (link) => {\n      const destinationURLWithVisitorIDs = await target.appendVisitorIDsTo(link.href);\n      link.href = destinationURLWithVisitorIDs.replace(/MCAID%3D.*%7CMCORGID/, 'MCAID%3D%7CMCORGID');\n    });\n  } catch (e) {\n    // eslint-disable-next-line no-console\n    console.error(e);\n  }\n}\n\n/**\n* get experiment details from Target\n* @returns {Promise<{\n*  experimentId: string;\n*  experimentVariant: string;\n* } | null>}\n  */\nexport const getTargetExperimentDetails = async () => {\n  /**\n   * @type {{\n   *  experimentId: string;\n   *  experimentVariant: string;\n   * }|null}\n   */\n  let targetExperimentDetails = null;\n\n  async function loadCSS(href) {\n    return new Promise((resolve, reject) => {\n      if (!document.querySelector(`head > link[href=\"${href}\"]`)) {\n        const link = document.createElement('link');\n        link.rel = 'stylesheet';\n        link.href = href;\n        link.onload = resolve;\n        link.onerror = reject;\n        document.head.append(link);\n      } else {\n        resolve();\n      }\n    });\n  }\n\n  const targetExperimentLocation = getMetadata('target-experiment-location');\n  const targetExperimentId = getMetadata('target-experiment');\n  if (targetExperimentLocation && targetExperimentId && !shouldABTestsBeDisabled()) {\n    const offer = await target.getOffers({ mboxNames: targetExperimentLocation });\n    const { url, template } = offer || {};\n    if (template) {\n      loadCSS(`${window.hlx.codeBasePath}/scripts/template-factories/${template}.css`);\n      document.body.classList.add(template);\n    }\n    targetExperimentDetails = await runTargetExperiment(url, targetExperimentId);\n  }\n\n  return targetExperimentDetails;\n};\n\nexport function adobeMcAppendVisitorId(selector) {\n  // https://experienceleague.adobe.com/docs/id-service/using/id-service-api/methods/appendvisitorid.html?lang=en\n\n  if (window.ADOBE_MC_EVENT_LOADED) {\n    appendAdobeMcLinks(selector);\n  } else {\n    document.addEventListener(GLOBAL_EVENTS.ADOBE_MC_LOADED, () => {\n      appendAdobeMcLinks(selector);\n    });\n  }\n}\n"],"names":["target","Target","PageLoadStartedEvent","page","generatePageLoadStartedName","User","getPlainPageUrl","url","pathname","search","hash","navigateToChallengerPage","plainPath","resp","mainElement","runTargetExperiment","experimentUrl","experimentId","sampleRUM","appendAdobeMcLinks","selector","link","destinationURLWithVisitorIDs","e","getTargetExperimentDetails","targetExperimentDetails","loadCSS","href","resolve","reject","targetExperimentLocation","getMetadata","targetExperimentId","shouldABTestsBeDisabled","offer","template","adobeMcAppendVisitorId","GLOBAL_EVENTS"],"mappings":"umBAaY,MAACA,EAAS,IAAIC,EAAO,CAC/B,qBAAsB,IAAIC,EACxBC,EACA,CACE,KAAMC,EAA6B,EACnC,UAAW,MAAMC,EAAK,QACtB,WAAY,UACb,CACF,CACH,CAAC,EAOD,SAASC,EAAgBC,EAAK,CAC5B,KAAM,CAAE,SAAAC,EAAU,OAAAC,EAAQ,KAAAC,CAAM,EAAG,IAAI,IAAIH,EAAK,OAAO,SAAS,IAAI,EAEpE,MAAO,GADmBC,EAAS,SAAS,GAAG,EAAI,GAAGA,CAAQ,mBAAqB,GAAGA,CAAQ,aACnE,GAAGC,CAAM,GAAGC,CAAI,EAC7C,CAOA,eAAeC,EAAyBJ,EAAK,CAC3C,MAAMK,EAAYN,EAAgBC,CAAG,EAE/BM,EAAO,MAAM,MAAMD,CAAS,EAClC,GAAI,CAACC,EAAK,GACR,MAAM,IAAI,MAAM,oCAAoCA,EAAK,MAAM,EAAE,EAGnE,MAAMC,EAAc,SAAS,cAAc,MAAM,EACjD,GAAI,CAACA,EACH,MAAM,IAAI,MAAM,wBAAwB,EAG1CA,EAAY,UAAY,MAAMD,EAAK,KAAM,CAC3C,CAWO,eAAeE,EAAoBC,EAAeC,EAAc,CACrE,GAAI,CAACD,EACH,OAAO,KAGT,GAAI,CACF,aAAML,EAAyBK,CAAa,EAE5CE,EAAU,oBAAqB,CAC7B,OAAQ,UAAUD,CAAY,GAC9B,OAAQD,CACd,CAAK,EAEM,CACL,aAAAC,EACA,kBAAmBD,CACpB,CACF,MAAW,CACV,OAAO,IACX,CACA,CAEO,SAASG,EAAmBC,EAAU,CAC3C,GAAI,EACsB,OAAOA,GAAa,SAAW,SAAS,cAAcA,CAAQ,EAAIA,GAG1E,iBADK,yBACwB,EAAE,QAAQ,MAAOC,GAAS,CACrE,MAAMC,EAA+B,MAAMtB,EAAO,mBAAmBqB,EAAK,IAAI,EAC9EA,EAAK,KAAOC,EAA6B,QAAQ,uBAAwB,oBAAoB,CACnG,CAAK,CACF,OAAQC,EAAG,CAEV,QAAQ,MAAMA,CAAC,CACnB,CACA,CASY,MAACC,EAA6B,SAAY,CAOpD,IAAIC,EAA0B,KAE9B,eAAeC,EAAQC,EAAM,CAC3B,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtC,GAAK,SAAS,cAAc,qBAAqBF,CAAI,IAAI,EAQvDC,EAAS,MARiD,CAC1D,MAAMP,EAAO,SAAS,cAAc,MAAM,EAC1CA,EAAK,IAAM,aACXA,EAAK,KAAOM,EACZN,EAAK,OAASO,EACdP,EAAK,QAAUQ,EACf,SAAS,KAAK,OAAOR,CAAI,CACjC,CAGA,CAAK,CACL,CAEE,MAAMS,EAA2BC,EAAY,4BAA4B,EACnEC,EAAqBD,EAAY,mBAAmB,EAC1D,GAAID,GAA4BE,GAAsB,CAACC,IAA2B,CAChF,MAAMC,EAAQ,MAAMlC,EAAO,UAAU,CAAE,UAAW8B,EAA0B,EACtE,CAAE,IAAAvB,EAAK,SAAA4B,CAAU,EAAGD,GAAS,CAAE,EACjCC,IACFT,EAAQ,GAAG,OAAO,IAAI,YAAY,+BAA+BS,CAAQ,MAAM,EAC/E,SAAS,KAAK,UAAU,IAAIA,CAAQ,GAEtCV,EAA0B,MAAMV,EAAoBR,EAAKyB,CAAkB,CAC/E,CAEE,OAAOP,CACT,EAEO,SAASW,EAAuBhB,EAAU,CAG3C,OAAO,sBACTD,EAAmBC,CAAQ,EAE3B,SAAS,iBAAiBiB,EAAc,gBAAiB,IAAM,CAC7DlB,EAAmBC,CAAQ,CACjC,CAAK,CAEL"}