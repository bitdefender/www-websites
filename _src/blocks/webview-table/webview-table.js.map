{"version":3,"file":"webview-table.js","sources":["../../../src/blocks/webview-table/webview-table.js"],"sourcesContent":["import { getLanguageCountryFromPath } from '../../scripts/scripts.js';\nimport { matchHeights } from '../../scripts/utils/utils.js';\n\nfunction replaceTableTextToProperCheckmars(block) {\n  block.querySelectorAll('div')\n    .forEach(async (div) => {\n      if (div.textContent.match(/^yes/i)) {\n        div.textContent = '';\n        const icon = document.createElement('div');\n        icon.classList.add('yes-check');\n        div.appendChild(icon);\n      } else if (div.textContent.match(/^no/i)) {\n        div.textContent = '';\n        const icon = document.createElement('div');\n        icon.classList.add('no-check');\n        div.appendChild(icon);\n      }\n    });\n}\n\nfunction buildTableHeader(block) {\n  const header = block.querySelector('div:nth-of-type(2)');\n\n  // Ensure the header exists before trying to modify it\n  if (header) {\n    header.classList.add('webview-comparison-header');\n  }\n}\n\nfunction addAccesibilityRoles(block) {\n  block.setAttribute('role', 'table');\n  const firstDiv = block.querySelector('div:first-of-type');\n  [...block.querySelectorAll('div')].filter((div) => !firstDiv.contains(div))\n    .forEach((div) => {\n      if (div.childElementCount > 1 && div.parentElement.getAttribute('role') === 'table') {\n        div.setAttribute('role', 'row');\n      } else if (div.childElementCount === 1 && div.innerHTML.indexOf('&lt;privacy-policy-text&gt;') !== -1) {\n        div.setAttribute('role', 'privacy-policy');\n        div.innerHTML = div.innerHTML.replace('&lt;privacy-policy-text&gt;', '');\n      } else if (!div.hasAttribute('role')) {\n        div.setAttribute('role', 'cell');\n      }\n    });\n\n  const header = block.querySelector('div:not(:first-child)');\n  [...header.children].forEach((headerColumns) => {\n    headerColumns.setAttribute('role', 'columnheader');\n  });\n}\n\nfunction renderPrices(block, metadata) {\n  const {\n    products, firstYearText, featuredProduct, currentProduct, saveText,\n  } = metadata;\n\n  const productsAsList = Array.from(products?.split(','));\n  const cells = block.querySelectorAll('div[role=\"cell\"]');\n  let index = 0; // Manual index increment\n\n  cells.forEach((cell) => {\n    // Only process cells that contain the {PRICEBOX} variable\n    if (cell.textContent.includes('{PRICEBOX}')) {\n      cell.parentElement.classList.add('price-row');\n      cell.querySelector('p')?.remove();\n      const [prodName, prodUsers, prodYears] = productsAsList[index]?.split('/') || [];\n\n      const buyBox = document.createElement('div');\n      buyBox.classList.add('buy-box', 'await-loader');\n\n      const savingsTag = document.createElement('div');\n      savingsTag.style.visibility = 'hidden';\n      savingsTag.classList.add('savings-tag-container');\n\n      // Determine if current product or featured product\n      const isFeatured = index + 1 === Number(featuredProduct);\n      const isCurrent = Number(currentProduct) === index + 1;\n      if (prodName && !isCurrent) {\n        cell.setAttribute('data-store-context', '');\n        cell.setAttribute('data-store-id', prodName);\n        cell.setAttribute('data-store-option', `${prodUsers}-${prodYears}`);\n        cell.setAttribute('data-store-department', 'consumer');\n        cell.setAttribute('data-store-event', 'product-loaded');\n      }\n      // Add featured logic if applicable\n      if (featuredProduct && isFeatured) {\n        block.querySelector(`div[role=\"columnheader\"]:nth-of-type(${Number(featuredProduct) + 1})`).classList.add('featured');\n        block.querySelectorAll('div[role=\"row\"]').forEach((row) => {\n          const featuredCell = row.querySelector(`div[role=\"cell\"]:nth-of-type(${Number(featuredProduct) + 1})`);\n          if (featuredCell) {\n            featuredCell.classList.add('featured');\n          }\n        });\n        block.setAttribute('data-store-context', '');\n        block.setAttribute('data-store-id', prodName);\n        block.setAttribute('data-store-option', `${prodUsers}-${prodYears}`);\n        block.setAttribute('data-store-department', 'consumer');\n        block.setAttribute('data-store-event', 'product-loaded');\n        savingsTag.innerHTML = `\n          <span class=\"saving-tag-text\" data-store-hide=\"no-price=discounted\">\n            <span data-store-discount=\"percentage\"></span> ${saveText || ''} \n          </span>\n        `;\n        savingsTag.style.visibility = 'visible';\n      }\n      // Populate buy box for non-current products\n      if (!isCurrent) {\n        buyBox.innerHTML = `\n          <div class=\"price-box\">\n            <div>\n              <span class=\"prod-oldprice\" data-store-price=\"full\" data-store-hide=\"no-price=discounted\"></span>\n            </div>\n            <div class=\"newprice-container mt-2\">\n              <span class=\"prod-newprice\"><span data-store-price=\"discounted||full\"></span></span>\n            </div>\n          </div>\n          <span class=\"under-price-text\">${firstYearText}</span>\n        `;\n        const buyLink = cell.querySelector('a[href*=\"#buylink\"]');\n        buyLink?.setAttribute('data-store-buy-link', '');\n      } else {\n        cell.classList.add('current');\n      }\n\n      cell.insertAdjacentElement('afterbegin', buyBox);\n      const tagCell = block.querySelector(`div[role=\"columnheader\"]:nth-of-type(${index + 2})`);\n      tagCell.insertAdjacentElement('afterbegin', savingsTag);\n\n      // eslint-disable-next-line no-plusplus\n      index++; // Increment index manually\n    }\n  });\n}\n\n// eslint-disable-next-line max-len\nfunction adjustFontSizeUntilTargetHeight(elementsSelector, targetElement, targetHeight, maxSize = 100, minSize = 10, step = 1, interval = 50) {\n  const elements = document.querySelectorAll(elementsSelector);\n\n  // Invalid selector or target element not found.\n  if (!elements.length || !targetElement) {\n    return;\n  }\n\n  let previousHeight = targetElement.offsetHeight;\n\n  function adjustSize() {\n    const currentHeight = targetElement.offsetHeight;\n\n    if (Math.abs(currentHeight - targetHeight) < 2) {\n      return; // Stop when the target height is reached\n    }\n\n    let fontChanged = false;\n\n    elements.forEach((el) => {\n      const currentSize = parseInt(window.getComputedStyle(el).fontSize, 10);\n\n      if (currentHeight < targetHeight && currentSize < maxSize) {\n        el.style.fontSize = `${currentSize + step}px`; // Increase size\n        fontChanged = true;\n      } else if (currentHeight > targetHeight && currentSize > minSize) {\n        el.style.fontSize = `${currentSize - step}px`; // Decrease size\n        fontChanged = true;\n      }\n    });\n\n    // Continue adjusting only if font size was changed\n    if (fontChanged) {\n      setTimeout(adjustSize, interval); // Slight delay for smooth adjustment\n    }\n  }\n\n  // Use MutationObserver to track height changes efficiently\n  const observer = new MutationObserver(() => {\n    const newHeight = targetElement.offsetHeight;\n    if (newHeight !== previousHeight) {\n      previousHeight = newHeight;\n      adjustSize();\n    }\n  });\n\n  observer.observe(targetElement, { attributes: true, childList: true, subtree: true });\n\n  adjustSize();\n}\n\nfunction getLanguage() {\n  // Try to get the language from the path\n  const langCountry = getLanguageCountryFromPath();\n  if (langCountry && langCountry.language && langCountry.country) {\n    return `${langCountry.language}-${langCountry.country}`;\n  }\n\n  // Try to get the language from the query parameter\n  const urlParams = new URLSearchParams(window.location.search);\n  const langFromQuery = urlParams.get('lang');\n  if (langFromQuery) {\n    return langFromQuery;\n  }\n\n  // Default to \"en-us\"\n  return 'en-us';\n}\n\nasync function checkAndReplacePrivacyPolicyLink(block) {\n  // Select the privacy-policy tag\n  const privacyPolicyTag = block.querySelector('[role=\"privacy-policy\"]');\n\n  if (privacyPolicyTag) {\n    // Select the link inside the privacy-policy tag\n    const privacyPolicyLink = privacyPolicyTag.querySelector('a');\n    const locale = getLanguage().toLowerCase();\n    if (privacyPolicyLink) {\n      privacyPolicyLink.href = privacyPolicyLink.href.replace('locale', locale);\n      privacyPolicyLink.setAttribute('target', '_blank');\n      const response = await fetch(privacyPolicyLink.href);\n      if (response.status === 404) {\n        // Replace the link with the en-us version\n        privacyPolicyLink.href = 'https://www.bitdefender.com/en-us/site/view/legal-privacy-policy-for-home-users-solutions.html';\n      }\n    }\n  }\n}\n\nexport default async function decorate(block) {\n  const metadata = block.closest('.section').dataset;\n  buildTableHeader(block);\n  addAccesibilityRoles(block);\n  replaceTableTextToProperCheckmars(block);\n  renderPrices(block, metadata);\n  matchHeights(block, '.savings-tag-container');\n  matchHeights(block, '.buy-box');\n\n  const url = new URL(window.location.href);\n  if (url.searchParams.has('theme') && url.searchParams.get('theme') === 'light') {\n    block.classList.add('light-mode');\n  }\n\n  // Check and replace privacy-policy link if it gives a 404\n  await checkAndReplacePrivacyPolicyLink(block);\n\n  const targetElement = document.querySelector('.webview-table');\n  adjustFontSizeUntilTargetHeight('.webview-table > div[role=\"row\"] > div:nth-child(1)', targetElement, 512);\n}\n"],"names":["replaceTableTextToProperCheckmars","block","div","icon","buildTableHeader","header","addAccesibilityRoles","firstDiv","headerColumns","renderPrices","metadata","products","firstYearText","featuredProduct","currentProduct","saveText","productsAsList","cells","index","cell","prodName","prodUsers","prodYears","buyBox","savingsTag","isFeatured","isCurrent","row","featuredCell","adjustFontSizeUntilTargetHeight","elementsSelector","targetElement","targetHeight","maxSize","minSize","step","interval","elements","previousHeight","adjustSize","currentHeight","fontChanged","el","currentSize","newHeight","getLanguage","langCountry","getLanguageCountryFromPath","langFromQuery","checkAndReplacePrivacyPolicyLink","privacyPolicyTag","privacyPolicyLink","locale","decorate","matchHeights","url"],"mappings":"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"}