{"version":3,"file":"mbox-canvas.js","sources":["../../../src/blocks/mbox-canvas/mbox-canvas.js"],"sourcesContent":["import { AdobeDataLayerService, WindowLoadStartedEvent } from '@repobit/dex-data-layer';\nimport { target } from '../../scripts/target.js';\nimport { decorateMain, detectModalButtons } from '../../scripts/scripts.js';\nimport { getMetadata, loadBlocks } from '../../scripts/lib-franklin.js';\nimport page from '../../scripts/page.js';\n\nfunction decorateHTMLOffer(aemHeaderHtml) {\n  const newHtml = document.createElement('div');\n  newHtml.innerHTML = aemHeaderHtml;\n  decorateMain(newHtml);\n  detectModalButtons(newHtml);\n\n  return newHtml;\n}\n\nfunction createOfferParameters() {\n  const parameters = {};\n  const urlParams = new URLSearchParams(window.location.search);\n  const feature = urlParams.get('feature');\n  const language = urlParams.get('lang');\n  urlParams.forEach((value) => {\n    if (value === feature) {\n      parameters.feature = feature.replaceAll('_', '-');\n    }\n    if (value === language) {\n      parameters.lang = language.toLocaleLowerCase();\n    }\n  });\n\n  return parameters;\n}\n\nfunction createOfferProfileParameters(parameters) {\n  const profileParameters = {};\n  Object.entries(parameters).forEach(([key, value]) => {\n    profileParameters[`profile.${key}`] = value;\n  });\n\n  return profileParameters;\n}\n\n/**\n * Updates the PageLoadStartedEvent with dynamic content from the offer\n * and pushes it to the AdobeDataLayerService.\n *\n * @param {Object} offer - The offer object containing dynamic content.\n * @returns {Promise<void>} - A promise that resolves when the event is updated and pushed.\n */\nasync function updatePageLoadStartedEvent(offer) {\n  const match = offer.offer.match(/\\/([^/]+)\\.plain\\.html$/);\n  const result = match ? match[1] : null;\n  let trackingID = getMetadata('cid');\n  trackingID = trackingID.replace('<language>', page.getParamValue('lang'));\n  trackingID = trackingID.replace('<asset name>', page.getParamValue('feature'));\n\n  const newObject = new WindowLoadStartedEvent((pageLoadStartedInfo) => {\n    pageLoadStartedInfo.name = pageLoadStartedInfo.name.replace('<dynamic-content>', result);\n    pageLoadStartedInfo.language = page.getParamValue('lang') || 'en-us';\n    return pageLoadStartedInfo;\n  }, { trackingID });\n\n  Object.entries(newObject.page.info).forEach(([key, value]) => {\n    if (value === '<dynamic-content>') {\n      newObject.page.info[key] = result;\n    }\n  });\n\n  AdobeDataLayerService.push(newObject);\n}\n\nexport default async function decorate(block) {\n  const {\n    // eslint-disable-next-line no-unused-vars\n    mboxName,\n  } = block.closest('.section').dataset;\n\n  const parameters = createOfferParameters();\n  block.innerHTML += `\n    <div class=\"canvas-content\">\n\n    </div>\n  `;\n  block.classList.add('loader-circle');\n  const offer = await target.getOffers({\n    mboxNames: mboxName,\n    parameters,\n    profileParameters: createOfferProfileParameters(parameters),\n  });\n  const pageCall = await fetch(`${offer.offer}`);\n  let offerHtml;\n  await loadBlocks(block.querySelector('.canvas-content'));\n\n  if (pageCall.ok) {\n    offerHtml = await pageCall.text();\n  } else {\n    const urlParams = new URLSearchParams(window.location.search);\n    const language = urlParams.get('lang')?.toLowerCase() || 'en-us';\n    let defaultOffer = await fetch(`/${language}/consumer/webview/webview-table.plain.html`);\n    if (defaultOffer.ok) {\n      offerHtml = await defaultOffer.text();\n    } else {\n      defaultOffer = await fetch('/en-us/consumer/webview/webview-table.plain.html');\n      offerHtml = await defaultOffer.text();\n    }\n  }\n\n  const decoratedOfferHtml = decorateHTMLOffer(offerHtml);\n  updatePageLoadStartedEvent(offer, mboxName);\n\n  // Make all the links that contain #buylink in href open in a new browser window\n  decoratedOfferHtml.querySelectorAll('a[href*=\"#buylink\"]').forEach((link) => {\n    link.setAttribute('target', '_blank');\n  });\n\n  block.querySelector('.canvas-content').innerHTML = decoratedOfferHtml.innerHTML;\n  await loadBlocks(block.querySelector('.canvas-content'));\n}\n"],"names":[],"mappings":"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"}