{"version":3,"file":"mbox-canvas.js","sources":["../../../src/blocks/mbox-canvas/mbox-canvas.js"],"sourcesContent":["import { AdobeDataLayerService, WindowLoadStartedEvent } from '@repobit/dex-data-layer';\nimport { target } from '../../scripts/target.js';\nimport { decorateMain, detectModalButtons } from '../../scripts/scripts.js';\nimport { getMetadata, loadBlocks } from '../../scripts/lib-franklin.js';\nimport page from '../../scripts/page.js';\n\nfunction decorateHTMLOffer(aemHeaderHtml) {\n  const newHtml = document.createElement('div');\n  newHtml.innerHTML = aemHeaderHtml;\n  decorateMain(newHtml);\n  detectModalButtons(newHtml);\n\n  return newHtml;\n}\n\nfunction createOfferParameters() {\n  const parameters = {};\n  const urlParams = new URLSearchParams(window.location.search);\n  const feature = urlParams.get('feature');\n  const language = urlParams.get('lang');\n  urlParams.forEach((value) => {\n    if (value === feature) {\n      parameters.feature = feature.replaceAll('_', '-');\n    }\n    if (value === language) {\n      parameters.lang = language.toLocaleLowerCase();\n    }\n  });\n\n  return parameters;\n}\n\nfunction createOfferProfileParameters(parameters) {\n  const profileParameters = {};\n  Object.entries(parameters).forEach(([key, value]) => {\n    profileParameters[`profile.${key}`] = value;\n  });\n\n  return profileParameters;\n}\n\n/**\n * Updates the PageLoadStartedEvent with dynamic content from the offer\n * and pushes it to the AdobeDataLayerService.\n *\n * @param {Object} offer - The offer object containing dynamic content.\n * @returns {Promise<void>} - A promise that resolves when the event is updated and pushed.\n */\nasync function updatePageLoadStartedEvent(offer) {\n  const match = offer.offer.match(/\\/([^/]+)\\.plain\\.html$/);\n  const result = match ? match[1] : null;\n  let trackingID = getMetadata('cid');\n  trackingID = trackingID.replace('<language>', page.getParamValue('lang'));\n  trackingID = trackingID.replace('<asset name>', page.getParamValue('feature'));\n\n  const newObject = new WindowLoadStartedEvent((pageLoadStartedInfo) => {\n    pageLoadStartedInfo.name = pageLoadStartedInfo.name.replace('<dynamic-content>', result);\n    pageLoadStartedInfo.language = page.getParamValue('lang') || 'en-us';\n    return pageLoadStartedInfo;\n  }, { trackingID });\n\n  Object.entries(newObject.page.info).forEach(([key, value]) => {\n    if (value === '<dynamic-content>') {\n      newObject.page.info[key] = result;\n    }\n  });\n\n  AdobeDataLayerService.push(newObject);\n}\n\nexport default async function decorate(block) {\n  const {\n    // eslint-disable-next-line no-unused-vars\n    mboxName,\n  } = block.closest('.section').dataset;\n\n  const parameters = createOfferParameters();\n  block.innerHTML += `\n    <div class=\"canvas-content\">\n\n    </div>\n  `;\n  block.classList.add('loader-circle');\n  const offer = await target.getOffers({\n    mboxNames: mboxName,\n    parameters,\n    profileParameters: createOfferProfileParameters(parameters),\n  });\n  const pageCall = await fetch(`${offer.offer}`);\n  let offerHtml;\n  await loadBlocks(block.querySelector('.canvas-content'));\n\n  if (pageCall.ok) {\n    offerHtml = await pageCall.text();\n  } else {\n    const urlParams = new URLSearchParams(window.location.search);\n    const language = urlParams.get('lang')?.toLowerCase() || 'en-us';\n    let defaultOffer = await fetch(`/${language}/consumer/webview/webview-table.plain.html`);\n    if (defaultOffer.ok) {\n      offerHtml = await defaultOffer.text();\n    } else {\n      defaultOffer = await fetch('/en-us/consumer/webview/webview-table.plain.html');\n      offerHtml = await defaultOffer.text();\n    }\n  }\n\n  const decoratedOfferHtml = decorateHTMLOffer(offerHtml);\n  updatePageLoadStartedEvent(offer, mboxName);\n\n  // Make all the links that contain #buylink in href open in a new browser window\n  decoratedOfferHtml.querySelectorAll('a[href*=\"#buylink\"]').forEach((link) => {\n    link.setAttribute('target', '_blank');\n  });\n\n  block.querySelector('.canvas-content').innerHTML = decoratedOfferHtml.innerHTML;\n  await loadBlocks(block.querySelector('.canvas-content'));\n}\n"],"names":["decorateHTMLOffer","aemHeaderHtml","newHtml","decorateMain","detectModalButtons","createOfferParameters","parameters","urlParams","feature","language","value","createOfferProfileParameters","profileParameters","key","updatePageLoadStartedEvent","offer","match","result","trackingID","getMetadata","page","newObject","WindowLoadStartedEvent","pageLoadStartedInfo","AdobeDataLayerService","decorate","block","mboxName","target","pageCall","offerHtml","loadBlocks","defaultOffer","decoratedOfferHtml","link"],"mappings":"ujBAMA,SAASA,EAAkBC,EAAe,CACxC,MAAMC,EAAU,SAAS,cAAc,KAAK,EAC5C,OAAAA,EAAQ,UAAYD,EACpBE,EAAaD,CAAO,EACpBE,EAAmBF,CAAO,EAEnBA,CACT,CAEA,SAASG,GAAwB,CAC/B,MAAMC,EAAa,CAAE,EACfC,EAAY,IAAI,gBAAgB,OAAO,SAAS,MAAM,EACtDC,EAAUD,EAAU,IAAI,SAAS,EACjCE,EAAWF,EAAU,IAAI,MAAM,EACrC,OAAAA,EAAU,QAASG,GAAU,CACvBA,IAAUF,IACZF,EAAW,QAAUE,EAAQ,WAAW,IAAK,GAAG,GAE9CE,IAAUD,IACZH,EAAW,KAAOG,EAAS,kBAAmB,EAEpD,CAAG,EAEMH,CACT,CAEA,SAASK,EAA6BL,EAAY,CAChD,MAAMM,EAAoB,CAAE,EAC5B,cAAO,QAAQN,CAAU,EAAE,QAAQ,CAAC,CAACO,EAAKH,CAAK,IAAM,CACnDE,EAAkB,WAAWC,CAAG,EAAE,EAAIH,CAC1C,CAAG,EAEME,CACT,CASA,eAAeE,EAA2BC,EAAO,CAC/C,MAAMC,EAAQD,EAAM,MAAM,MAAM,yBAAyB,EACnDE,EAASD,EAAQA,EAAM,CAAC,EAAI,KAClC,IAAIE,EAAaC,EAAY,KAAK,EAClCD,EAAaA,EAAW,QAAQ,aAAcE,EAAK,cAAc,MAAM,CAAC,EACxEF,EAAaA,EAAW,QAAQ,eAAgBE,EAAK,cAAc,SAAS,CAAC,EAE7E,MAAMC,EAAY,IAAIC,EAAwBC,IAC5CA,EAAoB,KAAOA,EAAoB,KAAK,QAAQ,oBAAqBN,CAAM,EACvFM,EAAoB,SAAWH,EAAK,cAAc,MAAM,GAAK,QACtDG,GACN,CAAE,WAAAL,CAAU,CAAE,EAEjB,OAAO,QAAQG,EAAU,KAAK,IAAI,EAAE,QAAQ,CAAC,CAACR,EAAKH,CAAK,IAAM,CACxDA,IAAU,sBACZW,EAAU,KAAK,KAAKR,CAAG,EAAII,EAEjC,CAAG,EAEDO,EAAsB,KAAKH,CAAS,CACtC,CAEe,eAAeI,EAASC,EAAO,CAC5C,KAAM,CAEJ,SAAAC,CACD,EAAGD,EAAM,QAAQ,UAAU,EAAE,QAExBpB,EAAaD,EAAuB,EAC1CqB,EAAM,WAAa;AAAA;AAAA;AAAA;AAAA,IAKnBA,EAAM,UAAU,IAAI,eAAe,EACnC,MAAMX,EAAQ,MAAMa,EAAO,UAAU,CACnC,UAAWD,EACX,WAAArB,EACA,kBAAmBK,EAA6BL,CAAU,CAC9D,CAAG,EACKuB,EAAW,MAAM,MAAM,GAAGd,EAAM,KAAK,EAAE,EAC7C,IAAIe,EAGJ,GAFA,MAAMC,EAAWL,EAAM,cAAc,iBAAiB,CAAC,EAEnDG,EAAS,GACXC,EAAY,MAAMD,EAAS,KAAM,MAC5B,CAEL,MAAMpB,EADY,IAAI,gBAAgB,OAAO,SAAS,MAAM,EACjC,IAAI,MAAM,GAAG,YAAW,GAAM,QACzD,IAAIuB,EAAe,MAAM,MAAM,IAAIvB,CAAQ,4CAA4C,EACnFuB,EAAa,GACfF,EAAY,MAAME,EAAa,KAAM,GAErCA,EAAe,MAAM,MAAM,kDAAkD,EAC7EF,EAAY,MAAME,EAAa,KAAM,EAE3C,CAEE,MAAMC,EAAqBjC,EAAkB8B,CAAS,EACtDhB,EAA2BC,CAAe,EAG1CkB,EAAmB,iBAAiB,qBAAqB,EAAE,QAASC,GAAS,CAC3EA,EAAK,aAAa,SAAU,QAAQ,CACxC,CAAG,EAEDR,EAAM,cAAc,iBAAiB,EAAE,UAAYO,EAAmB,UACtE,MAAMF,EAAWL,EAAM,cAAc,iBAAiB,CAAC,CACzD"}