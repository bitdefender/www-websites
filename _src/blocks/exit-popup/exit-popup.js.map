{"version":3,"file":"exit-popup.js","sources":["../../../src/blocks/exit-popup/exit-popup.js"],"sourcesContent":["import { target } from '../../scripts/target.js';\nimport { ProductInfo, Store } from '../../scripts/libs/store/store.js';\n// eslint-disable-next-line no-unused-vars\nexport default async function decorate(block) {\n  const parentSelector = block.closest('.section');\n  const { product, custompid } = parentSelector.dataset;\n\n  if (product) {\n    const [alias, devices, years] = product.split(',');\n    // eslint-disable-next-line no-undef\n    const exitPopupPromotion = (await target.getOffers({ mboxNames: 'exitPopupPid-mbox' }))?.promotion;\n    const products = await Store.getProducts([new ProductInfo(alias, 'consumer', exitPopupPromotion || custompid, true)]);\n    const productItem = products[alias];\n    const productCurrency = productItem.currency;\n    const productRegionId = productItem.regionId;\n    const variation = productItem.getOption(Number(devices), Number(years));\n    const percentPrice = variation.getDiscount('percentage');\n    const newPrice = variation.priceDiscounted;\n    const oldPrice = variation.price;\n\n    // discount in the title\n    const tileDiscountEl = block.querySelector('h5');\n    if (tileDiscountEl) tileDiscountEl.innerHTML = tileDiscountEl.innerHTML.replace('50%', `${percentPrice}%`);\n\n    // buy button\n    const buyBtnEl = block.querySelector('p.button-container a');\n    if (buyBtnEl) {\n      buyBtnEl.textContent = buyBtnEl.textContent.replace('50%', `${percentPrice}%`);\n      buyBtnEl.setAttribute('href', await variation.getStoreUrl());\n      buyBtnEl.setAttribute('data-product', alias);\n      buyBtnEl.setAttribute('data-buy-price', newPrice);\n      buyBtnEl.setAttribute('data-old-price', oldPrice);\n      buyBtnEl.setAttribute('data-currency', productCurrency);\n      buyBtnEl.setAttribute('data-region', productRegionId);\n      buyBtnEl.setAttribute('data-variation', `${devices}u-${years}y`);\n    }\n  }\n\n  // exit element: x\n  const exitEl = document.createElement('span');\n  exitEl.id = 'exit-action';\n  exitEl.innerHTML = '<img src=\"/_src/icons/close_x.JPG\" alt=\"Bitdefender\">';\n  block.appendChild(exitEl);\n\n  // popup configuration:\n  const POPUP_DISPLAY_LIMIT = 2;\n  const POPUP_TIMEOUT_DAYS = 30;\n  let popupDisplayCount = parseInt(localStorage.getItem('popupDisplayCount') || 0, 10);\n  const lastPopupDate = parseInt(localStorage.getItem('lastPopupDate') || 0, 10);\n\n  // if 30 days have passed\n  function hasThirtyDaysPassed(lastDisplayDate) {\n    const thirtyDaysInMs = POPUP_TIMEOUT_DAYS * 24 * 60 * 60 * 1000;\n    const now = Date.now();\n    return now - lastDisplayDate > thirtyDaysInMs;\n  }\n\n  // reset count if 30 days have passed\n  if (lastPopupDate && hasThirtyDaysPassed(lastPopupDate)) {\n    localStorage.removeItem('popupDisplayCount');\n    localStorage.removeItem('lastPopupDate');\n    popupDisplayCount = 0; // Reset count for the session\n  }\n\n  // event: mouseout -> display the popup\n  document.addEventListener('mouseout', (event) => {\n    if (popupDisplayCount < POPUP_DISPLAY_LIMIT && event.clientY < 0 && parentSelector) {\n      parentSelector.style.display = 'block';\n      document.dispatchEvent(new Event('exit_popup_display'));\n      window.exit_popup_display = true;\n\n      // add to the count\n      popupDisplayCount += 1;\n      localStorage.setItem('popupDisplayCount', popupDisplayCount.toString());\n\n      // last display time\n      localStorage.setItem('lastPopupDate', Date.now().toString());\n    }\n  });\n\n  // Close the popup: x-icon + background\n  const closePopup = () => {\n    const popup = document.querySelector('main .exit-popup-container');\n    if (popup) popup.style.display = 'none';\n  };\n\n  if (exitEl) exitEl.addEventListener('click', closePopup);\n  parentSelector.addEventListener('click', closePopup);\n}\n"],"names":[],"mappings":"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"}