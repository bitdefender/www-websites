{"version":3,"file":"exit-popup.js","sources":["../../../src/blocks/exit-popup/exit-popup.js"],"sourcesContent":["import { target } from '../../scripts/target.js';\nimport { ProductInfo, Store } from '../../scripts/libs/store/store.js';\n// eslint-disable-next-line no-unused-vars\nexport default async function decorate(block) {\n  const parentSelector = block.closest('.section');\n  const { product, custompid } = parentSelector.dataset;\n\n  if (product) {\n    const [alias, devices, years] = product.split(',');\n    // eslint-disable-next-line no-undef\n    const exitPopupPromotion = (await target.getOffers({ mboxNames: 'exitPopupPid-mbox' }))?.promotion;\n    const products = await Store.getProducts([new ProductInfo(alias, 'consumer', exitPopupPromotion || custompid, true)]);\n    const productItem = products[alias];\n    const productCurrency = productItem.currency;\n    const productRegionId = productItem.regionId;\n    const variation = productItem.getOption(Number(devices), Number(years));\n    const percentPrice = variation.getDiscount('percentage');\n    const newPrice = variation.priceDiscounted;\n    const oldPrice = variation.price;\n\n    // discount in the title\n    const tileDiscountEl = block.querySelector('h5');\n    if (tileDiscountEl) tileDiscountEl.innerHTML = tileDiscountEl.innerHTML.replace('50%', `${percentPrice}%`);\n\n    // buy button\n    const buyBtnEl = block.querySelector('p.button-container a');\n    if (buyBtnEl) {\n      buyBtnEl.textContent = buyBtnEl.textContent.replace('50%', `${percentPrice}%`);\n      buyBtnEl.setAttribute('href', await variation.getStoreUrl());\n      buyBtnEl.setAttribute('data-product', alias);\n      buyBtnEl.setAttribute('data-buy-price', newPrice);\n      buyBtnEl.setAttribute('data-old-price', oldPrice);\n      buyBtnEl.setAttribute('data-currency', productCurrency);\n      buyBtnEl.setAttribute('data-region', productRegionId);\n      buyBtnEl.setAttribute('data-variation', `${devices}u-${years}y`);\n    }\n  }\n\n  // exit element: x\n  const exitEl = document.createElement('span');\n  exitEl.id = 'exit-action';\n  exitEl.innerHTML = '<img src=\"/_src/icons/close_x.JPG\" alt=\"Bitdefender\">';\n  block.appendChild(exitEl);\n\n  // popup configuration:\n  const POPUP_DISPLAY_LIMIT = 2;\n  const POPUP_TIMEOUT_DAYS = 30;\n  let popupDisplayCount = parseInt(localStorage.getItem('popupDisplayCount') || 0, 10);\n  const lastPopupDate = parseInt(localStorage.getItem('lastPopupDate') || 0, 10);\n\n  // if 30 days have passed\n  function hasThirtyDaysPassed(lastDisplayDate) {\n    const thirtyDaysInMs = POPUP_TIMEOUT_DAYS * 24 * 60 * 60 * 1000;\n    const now = Date.now();\n    return now - lastDisplayDate > thirtyDaysInMs;\n  }\n\n  // reset count if 30 days have passed\n  if (lastPopupDate && hasThirtyDaysPassed(lastPopupDate)) {\n    localStorage.removeItem('popupDisplayCount');\n    localStorage.removeItem('lastPopupDate');\n    popupDisplayCount = 0; // Reset count for the session\n  }\n\n  // event: mouseout -> display the popup\n  document.addEventListener('mouseout', (event) => {\n    if (popupDisplayCount < POPUP_DISPLAY_LIMIT && event.clientY < 0 && parentSelector) {\n      parentSelector.style.display = 'block';\n      document.dispatchEvent(new Event('exit_popup_display'));\n      window.exit_popup_display = true;\n\n      // add to the count\n      popupDisplayCount += 1;\n      localStorage.setItem('popupDisplayCount', popupDisplayCount.toString());\n\n      // last display time\n      localStorage.setItem('lastPopupDate', Date.now().toString());\n    }\n  });\n\n  // Close the popup: x-icon + background\n  const closePopup = () => {\n    const popup = document.querySelector('main .exit-popup-container');\n    if (popup) popup.style.display = 'none';\n  };\n\n  if (exitEl) exitEl.addEventListener('click', closePopup);\n  parentSelector.addEventListener('click', closePopup);\n}\n"],"names":["decorate","block","parentSelector","product","custompid","alias","devices","years","exitPopupPromotion","target","productItem","Store","ProductInfo","productCurrency","productRegionId","variation","percentPrice","newPrice","oldPrice","tileDiscountEl","buyBtnEl","exitEl","POPUP_DISPLAY_LIMIT","POPUP_TIMEOUT_DAYS","popupDisplayCount","lastPopupDate","hasThirtyDaysPassed","lastDisplayDate","thirtyDaysInMs","event","closePopup","popup"],"mappings":"4HAGe,eAAeA,EAASC,EAAO,CAC5C,MAAMC,EAAiBD,EAAM,QAAQ,UAAU,EACzC,CAAE,QAAAE,EAAS,UAAAC,CAAW,EAAGF,EAAe,QAE9C,GAAIC,EAAS,CACX,KAAM,CAACE,EAAOC,EAASC,CAAK,EAAIJ,EAAQ,MAAM,GAAG,EAE3CK,GAAsB,MAAMC,EAAO,UAAU,CAAE,UAAW,mBAAqB,CAAA,IAAI,UAEnFC,GADW,MAAMC,EAAM,YAAY,CAAC,IAAIC,EAAYP,EAAO,WAAYG,GAAsBJ,EAAW,EAAI,CAAC,CAAC,GACvFC,CAAK,EAC5BQ,EAAkBH,EAAY,SAC9BI,EAAkBJ,EAAY,SAC9BK,EAAYL,EAAY,UAAU,OAAOJ,CAAO,EAAG,OAAOC,CAAK,CAAC,EAChES,EAAeD,EAAU,YAAY,YAAY,EACjDE,EAAWF,EAAU,gBACrBG,EAAWH,EAAU,MAGrBI,EAAiBlB,EAAM,cAAc,IAAI,EAC3CkB,IAAgBA,EAAe,UAAYA,EAAe,UAAU,QAAQ,MAAO,GAAGH,CAAY,GAAG,GAGzG,MAAMI,EAAWnB,EAAM,cAAc,sBAAsB,EACvDmB,IACFA,EAAS,YAAcA,EAAS,YAAY,QAAQ,MAAO,GAAGJ,CAAY,GAAG,EAC7EI,EAAS,aAAa,OAAQ,MAAML,EAAU,YAAW,CAAE,EAC3DK,EAAS,aAAa,eAAgBf,CAAK,EAC3Ce,EAAS,aAAa,iBAAkBH,CAAQ,EAChDG,EAAS,aAAa,iBAAkBF,CAAQ,EAChDE,EAAS,aAAa,gBAAiBP,CAAe,EACtDO,EAAS,aAAa,cAAeN,CAAe,EACpDM,EAAS,aAAa,iBAAkB,GAAGd,CAAO,KAAKC,CAAK,GAAG,EAErE,CAGE,MAAMc,EAAS,SAAS,cAAc,MAAM,EAC5CA,EAAO,GAAK,cACZA,EAAO,UAAY,wDACnBpB,EAAM,YAAYoB,CAAM,EAGxB,MAAMC,EAAsB,EACtBC,EAAqB,GAC3B,IAAIC,EAAoB,SAAS,aAAa,QAAQ,mBAAmB,GAAK,EAAG,EAAE,EACnF,MAAMC,EAAgB,SAAS,aAAa,QAAQ,eAAe,GAAK,EAAG,EAAE,EAG7E,SAASC,EAAoBC,EAAiB,CAC5C,MAAMC,EAAiBL,EAAqB,GAAK,GAAK,GAAK,IAE3D,OADY,KAAK,IAAK,EACTI,EAAkBC,CACnC,CAGMH,GAAiBC,EAAoBD,CAAa,IACpD,aAAa,WAAW,mBAAmB,EAC3C,aAAa,WAAW,eAAe,EACvCD,EAAoB,GAItB,SAAS,iBAAiB,WAAaK,GAAU,CAC3CL,EAAoBF,GAAuBO,EAAM,QAAU,GAAK3B,IAClEA,EAAe,MAAM,QAAU,QAC/B,SAAS,cAAc,IAAI,MAAM,oBAAoB,CAAC,EACtD,OAAO,mBAAqB,GAG5BsB,GAAqB,EACrB,aAAa,QAAQ,oBAAqBA,EAAkB,SAAQ,CAAE,EAGtE,aAAa,QAAQ,gBAAiB,KAAK,IAAG,EAAG,UAAU,EAEjE,CAAG,EAGD,MAAMM,EAAa,IAAM,CACvB,MAAMC,EAAQ,SAAS,cAAc,4BAA4B,EAC7DA,IAAOA,EAAM,MAAM,QAAU,OAClC,EAEGV,GAAQA,EAAO,iBAAiB,QAASS,CAAU,EACvD5B,EAAe,iBAAiB,QAAS4B,CAAU,CACrD"}