import{__vitePreload as b}from"../../../_virtual/preload-helper.js";const P=10,f={rumSamplingRate:P,audiences:{},audiencesMetaTagPrefix:"audience",audiencesQueryParameter:"audience",campaignsMetaTagPrefix:"campaign",campaignsQueryParameter:"campaign",experimentsRoot:"/experiments",experimentsConfigFile:"manifest.json",experimentsMetaTag:"experiment",experimentsQueryParameter:"experiment"};function h(){return navigator.userAgent.match(/bot|crawl|spider/i)}async function g(n,e,t){if(!n.length||!Object.keys(e.audiences).length)return null;const a=new URLSearchParams(window.location.search),s=a.has(e.audiencesQueryParameter)?t.toClassName(a.get(e.audiencesQueryParameter)):null;if(s)return n.includes(s)?[s]:[];const l=await Promise.all(n.map(r=>e.audiences[r]&&typeof e.audiences[r]=="function"?e.audiences[r]():!1));return n.filter((r,i)=>l[i])}async function v(n,e){const t=n.endsWith("/")?`${n}index.plain.html`:`${n}.plain.html`;try{const a=await fetch(t);if(!a.ok)return console.log("error loading content:",a),!1;const s=await a.text();return e.innerHTML=s,t}catch(a){console.log(`error loading content: ${t}`,a)}return null}function C(n,e){const t={};try{n.settings.data.forEach(r=>{const i=e.toCamelCase(r.Name);i==="audience"||i==="audiences"?t.audiences=r.Value?r.Value.split(",").map(u=>u.trim()):[]:i==="experimentName"?t.label=r.Value:t[i]=r.Value});const a={};let s=Object.keys(n.experiences.data[0]);s.shift(),s=s.map(r=>e.toCamelCase(r)),s.forEach(r=>{a[r]={}});let l="default";return n.experiences.data.forEach(r=>{let i=e.toCamelCase(r.Name);i||(i=l),l=i;const u=Object.keys(r);u.shift(),u.forEach(o=>{const c=e.toCamelCase(o);i==="pages"||i==="blocks"?(a[c][i]=a[c][i]||[],i==="pages"?a[c][i].push(new URL(r[o]).pathname):a[c][i].push(r[o])):a[c][i]=r[o]})}),t.variants=a,t.variantNames=s,t}catch(a){console.log("error parsing experiment config:",a,n)}return null}function $(n){return!(!n.variantNames||!n.variantNames.length||!n.variants||!Object.values(n.variants).length||!Object.values(n.variants).every(e=>typeof e=="object"&&!!e.blocks&&!!e.pages&&(e.percentageSplit===""||!!e.percentageSplit)))}function x(n){const e=[],t=n.reduce((a,s)=>(s.percentageSplit||e.push(s),a-parseFloat(s.percentageSplit||0)),1);if(e.length){const a=t/e.length;e.forEach(s=>{s.percentageSplit=a.toFixed(2)})}}function k(n,e,t,a){const s=a.getMetadata(`${t.experimentsMetaTag}-audience`),l={label:`Instant Experiment: ${n}`,audiences:s?s.split(",").map(a.toClassName):[],status:"Active",id:n,variants:{},variantNames:[]},r=e.split(",").map(o=>new URL(o.trim()).pathname),i=a.getMetadata(`${t.experimentsMetaTag}-split`),u=i?i.split(",").map(o=>parseInt(o,10)/100):[...new Array(r.length)].map(()=>1/(r.length+1));return l.variantNames.push("control"),l.variants.control={percentageSplit:"",pages:[window.location.pathname],blocks:[],label:"Control"},r.forEach((o,c)=>{const d=`challenger-${c+1}`;l.variantNames.push(d),l.variants[d]={percentageSplit:`${u[c].toFixed(2)}`,pages:[o],blocks:[],label:`Challenger ${c+1}`}}),x(Object.values(l.variants)),l}async function R(n,e,t){let a;n.includes(`/${e.experimentsConfigFile}`)?(a=new URL(n,window.location.origin).href,[n]=a.split("/").splice(-2,1)):a=`${e.experimentsRoot}/${n}/${e.experimentsConfigFile}`;try{const s=await fetch(a);if(!s.ok)return console.log("error loading experiment config:",s),null;const l=await s.json(),r=e.parser?e.parser(l,t):C(l,t);return r?(r.id=n,r.manifest=a,r.basePath=`${e.experimentsRoot}/${n}`,x(Object.values(r.variants)),r):null}catch(s){console.log(`error loading experiment manifest: ${a}`,s)}return null}function M(n){return{id:"content-experimentation-policy",rootDecisionNodeId:"n1",decisionNodes:[{id:"n1",type:"EXPERIMENTATION",experiment:{id:n.id,identityNamespace:"ECID",randomizationUnit:"DEVICE",treatments:Object.entries(n.variants).map(([t,a])=>({id:t,allocationPercentage:Number(a.percentageSplit)*100}))}}]}}async function E(n,e,t,a){const s=new URLSearchParams(window.location.search),[l,r]=s.has(t.experimentsQueryParameter)?s.get(t.experimentsQueryParameter).split("/"):[],i=e?await k(n,e,t,a):await R(n,t,a);if(console.debug(i),!i)return null;const u=s.has(t.audiencesQueryParameter)?a.toClassName(s.get(t.audiencesQueryParameter)):null;if(i.resolvedAudiences=await g(i.audiences.map(a.toClassName),t,a),i.run=(a.toCamelCase(i.status)==="active"||l)&&(!i.resolvedAudiences||i.resolvedAudiences.length)&&(!u||i.audiences.includes(u)),window.hlx=window.hlx||{},window.hlx.experiment=i,console.debug("run",i.run,i.audiences),r&&i.variantNames.includes(r))i.selectedVariant=r;else{const{ued:o}=await b(async()=>{const{ued:d}=await import("./ued.js");return{ued:d}},[]),c=o.evaluateDecisionPolicy(M(i),{});i.selectedVariant=c.items[0].id}return i}async function S(n,e,t){if(h())return!1;const a={...f,...e||{}},s=t.getMetadata(a.experimentsMetaTag);if(!s)return!1;const l=t.getMetadata("instant-experiment")||t.getMetadata(`${a.experimentsMetaTag}-variants`);let r;try{r=await E(s,l,a,t)}catch(N){console.error("Invalid experiment config.",N)}if(!r||!$(r))return console.warn("Invalid experiment config. Please review your metadata, sheet and parser."),!1;const i=new URLSearchParams(window.location.search),u=i.has(a.experimentsQueryParameter)?i.get(a.experimentsQueryParameter).split("/")[1]:null;if(!r.run&&!u)return console.warn("Experiment will not run. It is either not active or its configured audiences are not resolved."),!1;if(console.debug(`running experiment (${window.hlx.experiment.id}) -> ${window.hlx.experiment.selectedVariant}`),r.selectedVariant===r.variantNames[0])return t.sampleRUM("experiment",{source:r.id,target:r.selectedVariant}),!1;const{pages:o}=r.variants[r.selectedVariant];if(!o.length)return!1;const c=window.location.pathname,m=r.variants[r.variantNames[0]].pages.indexOf(c);if(m<0||o[m]===c)return!1;n.body.classList.add(`experiment-${t.toClassName(r.id)}`);const p=await v(o[m],n.querySelector("main"));return r.servedExperience=p||c,p||console.debug(`failed to serve variant ${window.hlx.experiment.selectedVariant}. Falling back to ${r.variantNames[0]}.`),n.body.classList.add(`variant-${t.toClassName(p?r.selectedVariant:r.variantNames[0])}`),t.sampleRUM("experiment",{source:r.id,target:p?r.selectedVariant:r.variantNames[0]}),p}async function V(n,e,t){if(h())return!1;const a={...f,...e},s=new URLSearchParams(window.location.search),l=(s.has(a.campaignsQueryParameter)?t.toClassName(s.get(a.campaignsQueryParameter)):null)||(s.has("utm_campaign")?t.toClassName(s.get("utm_campaign")):null);if(!l)return!1;let r=t.getMetadata(`${a.campaignsMetaTagPrefix}-audience`);if(r){r=r.split(",").map(t.toClassName);const o=await g(r,a,t);if(o&&!o.length)return!1}const i=t.getAllMetadata(a.campaignsMetaTagPrefix);if(!Object.keys(i).includes(l))return!1;const u=i[l];if(!u)return!1;window.hlx.campaign={selectedCampaign:l};try{const o=new URL(u),c=v(o.pathname,n.querySelector("main"));return window.hlx.campaign.servedExperience=c||window.location.pathname,c||console.debug(`failed to serve campaign ${l}. Falling back to default content.`),n.body.classList.add(`campaign-${l}`),t.sampleRUM("campaign",{source:window.location.href,target:c?l:"default"}),c}catch(o){return console.error(o),!1}}async function A(n,e,t){if(h())return!1;const a={...f,...e||{}},s=t.getAllMetadata(a.audiencesMetaTagPrefix);if(!Object.keys(s).length)return!1;const l=await g(Object.keys(s).map(t.toClassName),a,t);if(!l||!l.length)return!1;const r=new URLSearchParams(window.location.search),i=r.has(a.audiencesQueryParameter)?t.toClassName(r.get(a.audiencesQueryParameter)):null,u=i||l[0],o=s[u];if(!o)return!1;window.hlx.audience={selectedAudience:u};try{const c=new URL(o),d=v(c.pathname,n.querySelector("main"));return window.hlx.audience.servedExperience=d||window.location.pathname,d||console.debug(`failed to serve audience ${u}. Falling back to default content.`),n.body.classList.add(l.map(m=>`audience-${m}`)),t.sampleRUM("audiences",{source:window.location.href,target:d?i||l.join(","):"default"}),d}catch(c){return console.error(c),!1}}window.hlx.patchBlockConfig?.push(n=>{const{experiment:e}=window.hlx;if(!e||!e.run||e.selectedVariant===e.variantNames[0]||!e.variants[e.variantNames[0]].blocks||!e.variants[e.variantNames[0]].blocks.includes(n.blockName))return n;const t=e.variants[e.selectedVariant];if(!t.blocks.length)return n;let a=e.variants[e.variantNames[0]].blocks.indexOf("");if(a<0&&(a=e.variants[e.variantNames[0]].blocks.indexOf(n.blockName)),a<0&&(a=e.variants[e.variantNames[0]].blocks.indexOf(`/blocks/${n.blockName}`)),a<0)return n;let s="",l;if(/^https?:\/\//.test(t.blocks[a])){const i=new URL(t.blocks[a]);i.origin!==window.location.origin&&(s=i.origin),i.pathname!=="/"?l=i.pathname:l=`/blocks/${n.blockName}`}else l=`/blocks/${t.blocks[a]}`;if(!s&&!l)return n;const{codeBasePath:r}=window.hlx;return{...n,cssPath:`${s}${r}${l}/${n.blockName}.css`,jsPath:`${s}${r}${l}/${n.blockName}.js`}});let y=!1;function w(n,e,t){const a={...f,...e||{}};return s=>(!window.hlx.rum.isSelected&&!y&&(y=!0,window.hlx.rum.weight=Math.min(window.hlx.rum.weight,Math.max(a.rumSamplingRate,P)),window.hlx.rum.isSelected=window.hlx.rum.random*window.hlx.rum.weight<1,window.hlx.rum.isSelected&&t.sampleRUM(n,s)),!0)}async function U(n,e,t){t.sampleRUM.always.on("audiences",w("audiences",e,t)),t.sampleRUM.always.on("campaign",w("campaign",e,t)),t.sampleRUM.always.on("experiment",w("experiment",e,t));let a=await V(n,e,t);a||(a=await S(n,e,t)),a||(a=await A(n,e,t))}async function T(n,e,t){const a={...f,...e||{}};(window.location.hostname.endsWith("hlx.page")||window.location.hostname==="localhost"||typeof e.isProd=="function"&&!e.isProd()||e.prodHost&&e.prodHost!==window.location.host&&e.prodHost!==window.location.hostname&&e.prodHost!==window.location.origin)&&(await b(()=>import("./preview.js"),[])).default(n,a,{...t,getResolvedAudiences:g})}export{f as DEFAULT_OPTIONS,g as getResolvedAudiences,$ as isValidExperimentationConfig,U as loadEager,T as loadLazy,V as runCampaign,S as runExperiment,A as serveAudience};
//# sourceMappingURL=index.js.map
