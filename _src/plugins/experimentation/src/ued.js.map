{"version":3,"file":"ued.js","sources":["../../../../src/plugins/experimentation/src/ued.js"],"sourcesContent":["/*\n * Copyright 2022 Adobe. All rights reserved.\n * This file is licensed to you under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License. You may obtain a copy\n * of the License at http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under\n * the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS\n * OF ANY KIND, either express or implied. See the License for the specific language\n * governing permissions and limitations under the License.\n */\n\nvar storage = window.sessionStorage;\n\nfunction murmurhash3_32_gc(key, seed) {\n  var remainder = key.length & 3;\n  var bytes = key.length - remainder;\n  var c1 = 0xcc9e2d51;\n  var c2 = 0x1b873593;\n  var h1 = seed;\n  var k1;\n  var h1b;\n  var i = 0;\n  while (i < bytes) {\n      k1 =\n          ((key.charCodeAt(i) & 0xff)) |\n              ((key.charCodeAt(++i) & 0xff) << 8) |\n              ((key.charCodeAt(++i) & 0xff) << 16) |\n              ((key.charCodeAt(++i) & 0xff) << 24);\n      ++i;\n      k1 = ((((k1 & 0xffff) * c1) + ((((k1 >>> 16) * c1) & 0xffff) << 16))) & 0xffffffff;\n      k1 = (k1 << 15) | (k1 >>> 17);\n      k1 = ((((k1 & 0xffff) * c2) + ((((k1 >>> 16) * c2) & 0xffff) << 16))) & 0xffffffff;\n      h1 ^= k1;\n      h1 = (h1 << 13) | (h1 >>> 19);\n      h1b = ((((h1 & 0xffff) * 5) + ((((h1 >>> 16) * 5) & 0xffff) << 16))) & 0xffffffff;\n      h1 = (((h1b & 0xffff) + 0x6b64) + ((((h1b >>> 16) + 0xe654) & 0xffff) << 16));\n  }\n  k1 = 0;\n  switch (remainder) {\n      case 3: k1 ^= (key.charCodeAt(i + 2) & 0xff) << 16;\n      case 2: k1 ^= (key.charCodeAt(i + 1) & 0xff) << 8;\n      case 1:\n          k1 ^= (key.charCodeAt(i) & 0xff);\n          k1 = (((k1 & 0xffff) * c1) + ((((k1 >>> 16) * c1) & 0xffff) << 16)) & 0xffffffff;\n          k1 = (k1 << 15) | (k1 >>> 17);\n          k1 = (((k1 & 0xffff) * c2) + ((((k1 >>> 16) * c2) & 0xffff) << 16)) & 0xffffffff;\n          h1 ^= k1;\n  }\n  h1 ^= key.length;\n  h1 ^= h1 >>> 16;\n  h1 = (((h1 & 0xffff) * 0x85ebca6b) + ((((h1 >>> 16) * 0x85ebca6b) & 0xffff) << 16)) & 0xffffffff;\n  h1 ^= h1 >>> 13;\n  h1 = ((((h1 & 0xffff) * 0xc2b2ae35) + ((((h1 >>> 16) * 0xc2b2ae35) & 0xffff) << 16))) & 0xffffffff;\n  h1 ^= h1 >>> 16;\n  return h1 >>> 0;\n}\n\nvar TOTAL_BUCKETS = 10000;\nfunction getBucket(saltedId) {\n  var hash = murmurhash3_32_gc(saltedId, 0);\n  var hashFixedBucket = Math.abs(hash) % TOTAL_BUCKETS;\n  var bucket = hashFixedBucket / TOTAL_BUCKETS;\n  return bucket;\n}\nfunction pickWithWeightsBucket(allocationPercentages, treatments, bucket) {\n  var sum = allocationPercentages.reduce(function (partialSum, a) { return partialSum + a; }, 0);\n  var partialSum = 0.0;\n  for (var i = 0; i < treatments.length; i++) {\n      partialSum += Number(allocationPercentages[i].toFixed(2)) / sum;\n      if (bucket > partialSum) {\n          continue;\n      }\n      return treatments[i];\n  }\n}\nfunction assignTreatmentByVisitor(experimentid, identityId, allocationPercentages, treatments) {\n  var saltedId = experimentid + '.' + identityId;\n  var bucketId = getBucket(saltedId);\n  var treatmentId = pickWithWeightsBucket(allocationPercentages, treatments, bucketId);\n  return {\n      treatmentId: treatmentId,\n      bucketId: bucketId\n  };\n}\n\nvar LOCAL_STORAGE_KEY = 'unified-decisioning-experiments';\nfunction assignTreatment(allocationPercentages, treatments) {\n  var random = Math.random() * 100;\n  var i = treatments.length;\n  while (random > 0 && i > 0) {\n      i -= 1;\n      random -= +allocationPercentages[i];\n  }\n  return treatments[i];\n}\nfunction getLastExperimentTreatment(experimentId) {\n  var experimentsStr = storage.getItem(LOCAL_STORAGE_KEY);\n  if (experimentsStr) {\n      var experiments = JSON.parse(experimentsStr);\n      if (experiments[experimentId]) {\n          return experiments[experimentId].treatment;\n      }\n  }\n  return null;\n}\nfunction setLastExperimentTreatment(experimentId, treatment) {\n  var experimentsStr = storage.getItem(LOCAL_STORAGE_KEY);\n  var experiments = experimentsStr ? JSON.parse(experimentsStr) : {};\n  var now = new Date();\n  var expKeys = Object.keys(experiments);\n  expKeys.forEach(function (key) {\n      var date = new Date(experiments[key].date);\n      if ((now.getTime() - date.getTime()) > (1000 * 86400 * 30)) {\n          delete experiments[key];\n      }\n  });\n  var date = now.toISOString().split('T')[0];\n  experiments[experimentId] = { treatment: treatment, date: date };\n  storage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(experiments));\n}\nfunction assignTreatmentByDevice(experimentId, allocationPercentages, treatments) {\n  var cachedTreatmentId = getLastExperimentTreatment(experimentId);\n  var treatmentIdResponse;\n  if (!cachedTreatmentId || !treatments.includes(cachedTreatmentId)) {\n      var assignedTreatmentId = assignTreatment(allocationPercentages, treatments);\n      setLastExperimentTreatment(experimentId, assignedTreatmentId);\n      treatmentIdResponse = assignedTreatmentId;\n  }\n  else {\n      treatmentIdResponse = cachedTreatmentId;\n  }\n  return {\n      treatmentId: treatmentIdResponse\n  };\n}\n\nvar RandomizationUnit = {\n  VISITOR: 'VISITOR',\n  DEVICE: 'DEVICE'\n};\nfunction evaluateExperiment(context, experiment) {\n  var experimentId = experiment.id, identityNamespace = experiment.identityNamespace, _a = experiment.randomizationUnit, randomizationUnit = _a === void 0 ? RandomizationUnit.VISITOR : _a;\n  var identityMap = context.identityMap;\n  var treatments = experiment.treatments.map(function (item) { return item.id; });\n  var allocationPercentages = experiment.treatments.map(function (item) { return item.allocationPercentage; });\n  var treatmentAssignment = null;\n  switch (randomizationUnit) {\n      case RandomizationUnit.VISITOR: {\n          var identityId = identityMap[identityNamespace][0].id;\n          treatmentAssignment = assignTreatmentByVisitor(experimentId, identityId, allocationPercentages, treatments);\n          break;\n      }\n      case RandomizationUnit.DEVICE: {\n          treatmentAssignment = assignTreatmentByDevice(experimentId, allocationPercentages, treatments);\n          break;\n      }\n      default:\n          throw new Error(\"Unknow randomization unit\");\n  }\n  var evaluationResponse = {\n      experimentId: experimentId,\n      hashedBucket: treatmentAssignment.bucketId,\n      treatment: {\n          id: treatmentAssignment.treatmentId\n      }\n  };\n  return evaluationResponse;\n}\n\nfunction traverseDecisionTree(decisionNodesMap, context, currentNodeId) {\n  var _a = decisionNodesMap[currentNodeId], experiment = _a.experiment, type = _a.type;\n  if (type === 'EXPERIMENTATION') {\n      var treatment = evaluateExperiment(context, experiment).treatment;\n      return [treatment];\n  }\n}\nfunction evaluateDecisionPolicy(decisionPolicy, context) {\n  if (context.storage && context.storage instanceof Storage) {\n    storage = context.storage;\n  }\n  var decisionNodesMap = {};\n  decisionPolicy.decisionNodes.forEach(function (item) {\n      decisionNodesMap[item['id']] = item;\n  });\n  var items = traverseDecisionTree(decisionNodesMap, context, decisionPolicy.rootDecisionNodeId);\n  return {\n      items: items\n  };\n}\n\nexport const ued = { evaluateDecisionPolicy };\n"],"names":["storage","murmurhash3_32_gc","key","seed","remainder","bytes","c1","c2","h1","k1","h1b","i","TOTAL_BUCKETS","getBucket","saltedId","hash","hashFixedBucket","bucket","pickWithWeightsBucket","allocationPercentages","treatments","sum","partialSum","a","assignTreatmentByVisitor","experimentid","identityId","bucketId","treatmentId","LOCAL_STORAGE_KEY","assignTreatment","random","getLastExperimentTreatment","experimentId","experimentsStr","experiments","setLastExperimentTreatment","treatment","now","expKeys","date","assignTreatmentByDevice","cachedTreatmentId","treatmentIdResponse","assignedTreatmentId","RandomizationUnit","evaluateExperiment","context","experiment","identityNamespace","_a","randomizationUnit","identityMap","item","treatmentAssignment","evaluationResponse","traverseDecisionTree","decisionNodesMap","currentNodeId","type","evaluateDecisionPolicy","decisionPolicy","items","ued"],"mappings":"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"}